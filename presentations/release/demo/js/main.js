(()=>{"use strict";const t={TIME_SLOT:250,VIEWABLE_WIDTH:426,VIEWABLE_HEIGHT:240,PLAYABLE_WIDTH:500,DODGE_ENABLED:!0,DODGE_DOUBLE_TAP_TIMING:250,DODGE_TIMESPAN:250,DODGE_SPEED_BOOST:4,GUN_BARREL_OFFSETX:12,GUN_BARREL_OFFSETY:8,PROJECTILE_TRAILS_ENABLED:!0,BULLET_TRAIL_ALPHA:.25,BULLET_TRAIL_XOFFSET:-4,BULLET_TRAIL_YOFFSET:-4,PRODUCTION:!0};Object.freeze(t);class e{static EDIT="e";constructor(t){this.up=this.down=this.left=this.right=this.shoot=!1,this.pause=!1,this.rightReleaseTime=this.leftReleaseTime=this.dodgeLeftUntil=this.dodgeRightUntil=0,this.edit=!1,this.mousePos={x:null,y:null},this.mouseButtonHeld=!1,this.justReleasedKeys=new Set;const e=this;document.addEventListener("keydown",(t=>e.keyPress(t))),document.addEventListener("keyup",(t=>e.keyRelease(t))),t.addEventListener("mousemove",(t=>e.updateMousePos(t))),t.addEventListener("mousedown",(t=>{e.mouseButtonHeld=!0})),t.addEventListener("mouseup",(t=>{e.mouseButtonHeld=!1}))}flipInputState(e,s){switch(e){case" ":this.shoot=s;break;case"a":case"ArrowLeft":if(this.left=s,t.DODGE_ENABLED){let e=performance.now();s?performance.now()<this.leftReleaseTime+t.DODGE_DOUBLE_TAP_TIMING&&(this.dodgeLeftUntil=e+t.DODGE_TIMESPAN):(this.leftReleaseTime=e,this.dodgeLeftUntil=0)}break;case"d":case"ArrowRight":if(this.right=s,t.DODGE_ENABLED){let e=performance.now();s?performance.now()<this.rightReleaseTime+t.DODGE_DOUBLE_TAP_TIMING&&(this.dodgeRightUntil=e+t.DODGE_TIMESPAN):(this.rightReleaseTime=e,this.dodgeRightUntil=0)}break;case"w":case"ArrowUp":this.up=s;break;case"s":case"ArrowDown":this.down=s;break;case"e":this.edit=s;break;case"p":case"Tab":!1===s&&(this.pause=!this.pause)}}keyPress(t){t.defaultPrevented||t.repeat||"F12"!=t.key&&(t.preventDefault(),this.flipInputState(t.key,!0))}keyRelease(t){t.defaultPrevented||"F12"!=t.key&&(t.preventDefault(),this.justReleasedKeys.add(t.key),this.flipInputState(t.key,!1))}updateMousePos(t){const e=t.target.getBoundingClientRect(),s=t.target.width/e.width,i=t.target.height/e.height,h=document.documentElement;this.mousePos.x=s*(t.clientX-e.left-h.scrollLeft),this.mousePos.y=i*(t.clientY-e.top-h.scrollTop)}}class s{constructor(t,e,s){this.frames=t,this.index=0,this.playing=void 0!==this.frames[this.index]&&void 0!==this.frames[this.index],this.timer=0,this.hFlip=void 0!==e&&e,this.loop=void 0!==s&&s}update(t){this.playing&&(this.timer+=t,this.timer>=this.frames[this.index].time/1e3&&(this.timer=0,++this.index>=this.frames.length&&(this.loop?this.index=0:this.playing=!1)))}draw(t,e,s,i){if(!this.playing)return;const h=this.frames[this.index];this.hFlip?(t.translate(s+h.sWidth,i),t.scale(-1,1),t.drawImage(e[h.id],h.sx,h.sy,h.sWidth,h.sHeight,0,0,h.sWidth,h.sHeight),t.setTransform(1,0,0,1,0,0)):t.drawImage(e[h.id],h.sx,h.sy,h.sWidth,h.sHeight,Math.round(s),Math.round(i),h.sWidth,h.sHeight)}}class i{static alive=function*(){for(const t of this.INSTANCES)t.needsUpdate&&(yield t)};static spawn(...t){let e=this.INSTANCES.filter((t=>!(t.live||t.needsUpdate))).pop();return void 0===e?(e=new this(...t),this.INSTANCES.push(e)):e.init(...t),e}constructor(t,e,s,i,h,...a){this.init(t,e,s,i,h,...a)}init(t,e,s,i,h,a,...n){this.live=!0,this.needsUpdate=!0,this.x=t,this.y=e,this.width=s,this.height=i,this.imageSpec=h,this.hp=10,this.blastQueue=[],this.beingHurt=!1,this.enableHurtFX=!0,this.bounty=a||10,this.currentAnimation=null,this.prevAccTime=0,this.hp=10}update(t,e){const s=t-this.prevAccTime;this.prevAccTime=t,this.live&&this.hp<=0&&this.die(),this.beingHurt&&performance.now()-this.hurtTime>=90&&(this.beingHurt=!1),null!==this.currentAnimation&&this.currentAnimation.update(s),this.needsUpdate=this.live||null!==this.currentAnimation&&this.currentAnimation.playing}draw(t,e,s){if(null!==this.currentAnimation&&this.currentAnimation.playing)this.currentAnimation.draw(t,e,this.x-s,this.y);else if(this.live&&(t.drawImage(e[this.imageSpec.id],this.imageSpec.sx,this.imageSpec.sy,this.imageSpec.sWidth,this.imageSpec.sHeight,Math.round(this.x-s),Math.round(this.y),this.width,this.height),this.beingHurt&&this.enableHurtFX)){const e=this.globalCompositeOperation;t.globalCompositeOperation="source-over",t.fillStyle="red";const i=t.globalAlpha;t.globalAlpha=.6,t.arc(Math.round(this.x+this.width/2-s),Math.round(this.y+this.height/2),Math.round(this.width/2),0,2*Math.PI),t.fill(),t.globalCompositeOperation=e,t.globalAlpha=i}}blast(t,e){for(;this.blastQueue.length>0;){const s=this.blastQueue.pop(),i=t.createBufferSource();i.buffer=e[s],i.connect(t.destination),i.start()}}hurt(t){this.live&&!this.beingHurt&&(this.hp-=t,this.beingHurt=!0,this.hurtTime=performance.now(),this.imageSpec.animations&&this.imageSpec.animations.hurt&&(this.currentAnimation=new s(this.imageSpec.animations.hurt)))}die(){this.imageSpec.animations&&this.imageSpec.animations.death&&(this.currentAnimation=new s(this.imageSpec.animations.death)),this.live=!1,this.beingHurt=!1}}class h extends i{static INSTANCES=[];init(t,e,s,i,h,a,n,o,l){return super.init(t,e,s,i,h,a,n,o,l),this.radius=s,this.target=a,this.velocity={x:n*(this.target.x-this.x),y:n*(this.target.y-this.y)},this.hooks=l,this.reachedTarget=!1,this.startx=t,this.starty=e,this}update(t){this.x+=this.velocity.x*t,this.y+=this.velocity.y*t,this.reachedTarget=this.velocity.y>0?this.y>this.target.y+this.target.height/8:this.y<this.target.y,this.reachedTarget&&(this.live=!1,this.needsUpdate=!1,this.hooks.forEach((e=>e(t,this))))}drawBitmapLine(t,e,s,i,h,a,n){var o=Math.sqrt(Math.pow(h-s,2)+Math.pow(a-i,2)),l=Math.atan2(a-i,h-s);o<1&&(l=0,o=1),t.save(),t.translate(s,i),t.rotate(l),t.translate(0,-e.height/2),t.globalAlpha=n,t.drawImage(e,0,0,e.width,e.height,0,0,o,e.height),t.globalAlpha=1,t.restore()}draw(e,s,i){const h=this.reachedTarget?this.target.x:this.x,a=this.reachedTarget?this.target.y:this.y;t.PROJECTILE_TRAILS_ENABLED&&this.drawBitmapLine(e,s.bullet_trail,this.startx,this.starty,h+t.BULLET_TRAIL_XOFFSET,a+t.BULLET_TRAIL_YOFFSET,t.BULLET_TRAIL_ALPHA),e.drawImage(s[this.imageSpec.id],this.imageSpec.sx,this.imageSpec.sy,this.imageSpec.sWidth,this.imageSpec.sHeight,Math.round(h-i-this.imageSpec.sWidth/2),Math.round(a-1.5*this.imageSpec.sHeight),this.imageSpec.sWidth,this.imageSpec.sHeight)}}class a extends i{static INSTANCES=[];static KINDS={GRAVE_1:{imageSpec:{id:"graveyardProps",sx:0,sy:0,sWidth:32,sHeight:32}},GRAVE_2:{imageSpec:{id:"graveyardProps",sx:32,sy:0,sWidth:32,sHeight:32}},GRAVE_3:{imageSpec:{id:"graveyardProps",sx:64,sy:0,sWidth:32,sHeight:32}},BUSH_1:{imageSpec:{id:"graveyardProps",sx:0,sy:32,sWidth:32,sHeight:32}},BUSH_2:{imageSpec:{id:"graveyardProps",sx:32,sy:32,sWidth:32,sHeight:32}},BUSH_3:{imageSpec:{id:"graveyardProps",sx:64,sy:32,sWidth:32,sHeight:32}},ROCK_1:{imageSpec:{id:"graveyardProps",sx:0,sy:64,sWidth:32,sHeight:32}},ROCK_2:{imageSpec:{id:"graveyardProps",sx:32,sy:64,sWidth:32,sHeight:32}}};init(t,e,s,i,h){super.init(t,e,s,i,h,10),this.hp=40}}class n extends i{static INSTANCES=[];static GRAVITY=256;init(t,e,s,i,h){super.init(t,e,s,i,h,10),this.hp=Math.Infinity,this.enableHurtFX=!1,this.vel={x:0,y:0},this.drop=!1}update(e){this.drop&&(this.vel.y+=n.GRAVITY*e,this.y+=this.vel.y*e),this.y>t.VIEWABLE_HEIGHT-this.height-2&&(this.y=t.VIEWABLE_HEIGHT-this.height-2,this.drop=!1)}hurt(t){super.hurt(t),this.drop=!0,this.vel.y=-128}}function o(t,e){return t.x>e.x&&t.y>e.y&&t.x<e.x+e.width&&t.y<e.y+e.height}function l(){return Array.from(d.alive()).concat(Array.from(a.alive())).sort(((t,e)=>t.y-e.y)).concat(Array.from(n.alive())).concat(Array.from(h.alive()))}class r extends i{init(t,e,s,i,h,a,n,...o){super.init(t,e,s,i,h,n,...o),this.attacked=!1,this.sfx=a}update(t,e){super.update(t,e),this.live}attack(t,e){this.attacked=!0,e.wasKilled}move(t){}hurt(t){super.hurt(t),this.hp<=0&&this.blastQueue.push(this.sfx.death)}}class d extends r{static INSTANCES=[];static KINDS={TOASTER_BAT:{imageSpec:{id:"toaster",sx:0,sy:0,sWidth:32,sHeight:32},sfx:{shoot:"toasterAttack"},bounty:10},RASPBERRY_DONUT:{imageSpec:{id:"donutSheet",sx:0,sy:0,sWidth:32,sHeight:32,animations:{death:[{id:"donutSheet",sx:32,sy:0,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:64,sy:0,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:96,sy:0,sWidth:32,sHeight:32,time:100},{id:"donutSheet",sx:128,sy:0,sWidth:32,sHeight:32,time:1e3}],hurt:[{id:"donutSheet",sx:160,sy:0,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:192,sy:0,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:224,sy:0,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:256,sy:0,sWidth:32,sHeight:32,time:90}]}},sfx:{death:"donutDeath"},bounty:10},CHOCO_DONUT:{imageSpec:{id:"donutSheet",sx:0,sy:32,sWidth:32,sHeight:32,animations:{death:[{id:"donutSheet",sx:32,sy:32,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:64,sy:32,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:96,sy:32,sWidth:32,sHeight:32,time:100},{id:"donutSheet",sx:128,sy:32,sWidth:32,sHeight:32,time:1e3}],hurt:[{id:"donutSheet",sx:160,sy:32,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:192,sy:32,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:224,sy:32,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:256,sy:32,sWidth:32,sHeight:32,time:90}]}},sfx:{death:"donutDeath"},bounty:10},FROSTED_DONUT:{imageSpec:{id:"donutSheet",sx:0,sy:64,sWidth:32,sHeight:32,animations:{death:[{id:"donutSheet",sx:32,sy:64,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:64,sy:64,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:96,sy:64,sWidth:32,sHeight:32,time:100},{id:"donutSheet",sx:128,sy:64,sWidth:32,sHeight:32,time:1e3}],hurt:[{id:"donutSheet",sx:160,sy:64,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:192,sy:64,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:224,sy:64,sWidth:32,sHeight:32,time:90},{id:"donutSheet",sx:256,sy:64,sWidth:32,sHeight:32,time:90}]}},sfx:{death:"donutDeath"},bounty:10},ESPRESSO:{imageSpec:{id:"expressoGangsterSheet",sx:0,sy:0,sWidth:45,sHeight:32,animations:{}},sfx:{death:"espressoDeath",shoot:"espressoAttack1"},bounty:20},EVIL_PRINTER:{imageSpec:{id:"printerSheet",sx:0,sy:0,sWidth:32,sHeight:32,animations:{death:[{id:"printerSheet",sx:32,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:64,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:96,sy:0,sWidth:32,sHeight:32,time:100},{id:"printerSheet",sx:128,sy:0,sWidth:32,sHeight:32,time:1e3}],hurt:[{id:"printerSheet",sx:160,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:192,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:224,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:256,sy:0,sWidth:32,sHeight:32,time:90},{id:"printerSheet",sx:288,sy:0,sWidth:32,sHeight:32,time:90}]}},sfx:{death:"printerDeath",shoot:"printerShoot"},bounty:30}};init(t,e,s,i,h,a,n,o,l,r){super.init(t,e,s,i,h,o,a,l,r),this.startX=t,this.endX=n||this.startX,this.walkSpeed=64,this.popOutSpeed=24,this.startY=e,this.endX==this.startX?(this.endY=this.y-this.height/2,this.velX=0,this.velY=Math.sign(this.endY-this.startY)*this.popOutSpeed,this.endMoveTime=(this.endY-this.startY)/this.velY):(this.endY=this.y,this.velY=0,this.velX=Math.sign(this.endX-this.startX)*this.walkSpeed,this.endMoveTime=(this.endX-this.startX)/this.velX),l=void 0===l?1:l||1,this.endAttackTime=this.endMoveTime+l,this.timeToReturn=void 0===r?1:r||1,this.itemDropChance=Math.random()}update(e,s){super.update(e,s),e<this.endMoveTime?this.move(e):e<this.endAttackTime?this.waitToAttack(e):this.attacked?e>this.endAttackTime+this.timeToReturn&&(this.moveBack(e),(this.x+this.width<0||this.x>t.PLAYABLE_WIDTH||this.y>this.startY)&&(this.live=!1,this.needsUpdate=!1)):this.attack(e,s)}attack(t,e){this.x=this.endX,this.y=this.endY,super.attack(t,e),h.spawn(this.x+this.width/2,this.y+this.height/2,1.5,1.5,{id:"bullets",sx:12,sy:2,sWidth:6,sHeight:6},{x:e.avatarPos.x+p.avatarWidth/2,y:e.avatarPos.y+p.avatarHeight/2,height:p.avatarHeight/2},1,1,[(t,s)=>{o(s,Object.assign({width:p.avatarWidth,height:p.avatarHeight},e.avatarPos))&&e.takeShot(this,s)}]),this.blastQueue.push(this.sfx.shoot||"enemyShoot")}move(t){super.move(t),this.x=this.startX+this.velX*t,this.y=this.startY+this.velY*t}moveBack(t){this.x=this.endX-this.velX*(t-this.endAttackTime-this.timeToReturn),this.y=this.endY-this.velY*(t-this.endAttackTime-this.timeToReturn)}waitToAttack(t){this.x=this.endX,this.y=this.endY}die(){this.itemDropChance>=.5&&n.spawn(this.x,this.y,15,23,{id:"gems",sx:0,sy:0,sWidth:15,sHeight:23}),super.die()}}class c extends r{static INSTANCES=[];move(t){}moveBack(t){}}class g extends c{static CHANGE_DIR_DIST=t.VIEWABLE_WIDTH-64;init(t,e,s){super.init(t,e,49,63,{id:"unibrain",sx:0,sy:0,sWidth:49,sHeight:63,animations:{}},{death:"espressoDeath"},s),this.hp=10,this.velX=144,this.startX=this.x,this.resetTimeToAttack(),this.resetWaitToShootTime()}resetTimeToAttack(){this.timeToAttack=Math.random()+3}resetWaitToShootTime(){this.waitToShootTime=Math.random()+1}update(t,e){const s=t-this.prevAccTime;this.prevAccTime=t,this.timeToAttack<=0?this.attack(s,e):(this.timeToAttack-=s,this.move(s)),super.update(t,e)}move(t){this.x+=this.velX*t,Math.abs(this.x-this.startX)>=g.CHANGE_DIR_DIST&&(this.velX*=-1,this.startX=this.x)}attack(t,e){this.waitToShootTime<=0?(this.blastQueue.push("uniBrainAttack"),h.spawn(this.x+this.width/2,this.y+this.height/2,1.5,1.5,{id:"bullets",sx:12,sy:2,sWidth:6,sHeight:6},{x:e.avatarPos.x+p.avatarWidth/2,y:e.avatarPos.y+p.avatarHeight/2,height:p.avatarHeight/2},2,1,[(t,s)=>{o(s,Object.assign({width:p.avatarWidth,height:p.avatarHeight},e.avatarPos))&&e.takeShot(this,s)}]),this.resetTimeToAttack(),this.resetWaitToShootTime()):this.waitToShootTime-=t}}class u extends c{static CHANGE_DIR_DIST=t.VIEWABLE_WIDTH-32;init(t,e,s){super.init(t,e,49,63,{id:"evilWitch",sx:0,sy:0,sWidth:50,sHeight:65,animations:{}},{death:"evilWitchDeath"},s),this.hp=10,this.velX=128,this.velY=8,this.sinX=this.x,this.startX=this.x,this.resetTimeToAttack(),this.resetWaitToShootTime(),this.shootSounds=["evilWitchAttack1","evilWitchAttack2"]}resetTimeToAttack(){this.timeToAttack=Math.random()+2}resetWaitToShootTime(){this.waitToShootTime=Math.random()+1}update(t,e){const s=t-this.prevAccTime;this.prevAccTime=t,this.timeToAttack<=0?this.attack(s,e):(this.timeToAttack-=s,this.move(s)),super.update(t,e)}move(t){this.x+=this.velX*t,this.sinX+=this.velY*t,this.y=50*(Math.sin(this.sinX)+1)/2+50,Math.abs(this.x-this.startX)>=g.CHANGE_DIR_DIST&&(this.velX*=-1,this.startX=this.x)}attack(t,e){this.waitToShootTime<=0?(this.blastQueue.push(this.shootSounds[Math.floor(2*Math.random())]),h.spawn(this.x+this.width/2,this.y+this.height/2,1.5,1.5,{id:"bullets",sx:12,sy:2,sWidth:6,sHeight:6},{x:e.avatarPos.x+p.avatarWidth/2,y:e.avatarPos.y+p.avatarHeight/2,height:p.avatarHeight/2},4,1,[(t,s)=>{o(s,Object.assign({width:p.avatarWidth,height:p.avatarHeight},e.avatarPos))&&e.takeShot(this,s)}]),this.resetTimeToAttack(),this.resetWaitToShootTime()):this.waitToShootTime-=t}}class p{static avatarHeight=49;static avatarWidth=28;static reticleSpeed=270;static avatarSpeed=120;static timeToRespawn=3;static respawnInvincibilityTime=2;static player1ImageSpec={id:"player1Back",sx:8,sy:0,sWidth:27,sHeight:48,animations:{move:[{id:"player1Side",sx:0,sy:0,sWidth:49,sHeight:50,time:90},{id:"player1Side",sx:50,sy:0,sWidth:51,sHeight:50,time:90},{id:"player1Side",sx:0,sy:50,sWidth:49,sHeight:50,time:90},{id:"player1Side",sx:50,sy:50,sWidth:51,sHeight:50,time:90}]}};static player2ImageSpec={id:"player2",sx:0,sy:0,sWidth:28,sHeight:49,animations:{move:[{id:"player2",sx:31,sy:0,sWidth:34,sHeight:49,time:180},{id:"player2",sx:31,sy:49,sWidth:34,sHeight:49,time:180},{id:"player2",sx:31,sy:0,sWidth:34,sHeight:49,time:180},{id:"player2",sx:31,sy:100,sWidth:34,sHeight:49,time:180}]}};static getAxis=function(t,e,s,i){let h={x:0,y:0};return t?h.y+=-1:e&&(h.y+=1),s?h.x+=-1:i&&(h.x+=1),h};static clampNorm=function(t,e){const s=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),i=Math.min(s,e)/s;return{x:i*t.x,y:i*t.y}};setBoss(t){this.boss=t}unsetBoss(){this.boss=null}getTargets(){const t=l().reverse();return this.boss&&this.boss.live&&t.push(this.boss),t}getHitTargetHook(){const t=this;return function(e,s){for(const e of t.getTargets())if(e.live&&Math.sqrt(Math.pow(e.x+e.width/2-s.target.x,2)+Math.pow(e.y+e.height/2-s.target.y,2))<=16){e.hurt(5),e.hp<=0&&(t.score+=e.bounty,e instanceof d?t.levelStats.kills++:e instanceof a&&t.levelStats.vandalism++);break}}}constructor(t,e,s){this.lives=4,this.score=0,this.avatarPos={x:100,y:t.y},this.reticlePos={x:t.x+4,y:t.y-100},this.shots=[],this.shotDelay=0,this.isShooting=!1,this.blastQueue=[],this.wasKilled=!1,this.respawnTimer=0,this.respawning=!0,this.invincibleTimer=0,this.gun=s,this.levelStats={kills:0,items:0,vandalism:0},this.facing="front",this.imageSpec=e,this.currentAnimation=null}resetLevelStats(){this.levelStats.kills=0,this.levelStats.items=0,this.levelStats.vandalism=0}update(e,i,h){if(this.lives<=0)return;if(null!==this.currentAnimation&&this.currentAnimation.update(e),this.wasKilled){if(this.respawnTimer<p.timeToRespawn&&(null===this.currentAnimation||!this.currentAnimation.playing))return void(this.respawnTimer+=e);this.respawnTimer=0,this.wasKilled=!1,this.invincibleTimer=p.respawnInvincibilityTime}if(this.invincibleTimer>0&&(this.invincibleTimer-=e),this.shots=this.shots.filter((t=>t.live)),i.shoot){if(this.shotDelay<=0){this.isShooting=!0;let e=t.GUN_BARREL_OFFSETX;"right"==this.facing&&(e=t.GUN_BARREL_OFFSETX),"left"==this.facing&&(e=-1*t.GUN_BARREL_OFFSETX);const i=this.gun.fire(this.avatarPos.x+p.avatarWidth/2+e,this.avatarPos.y+t.GUN_BARREL_OFFSETY,{x:this.reticlePos.x,y:this.reticlePos.y,width:3,height:3},[this.getHitTargetHook()]);this.shots.push(...i),this.blastQueue.push(this.gun.shootingSound),this.shotDelay=this.gun.timeBetweenShots,this.currentAnimation=void 0===this.imageSpec.animations.shoot?null:new s(this.imageSpec.animations.death)}}else{if(i.left){let s=i.dodgeLeftUntil>performance.now()?t.DODGE_SPEED_BOOST:1;this.avatarPos.x=Math.max(0,this.avatarPos.x-p.avatarSpeed*e*s)}if(i.right){let s=i.dodgeRightUntil>performance.now()?t.DODGE_SPEED_BOOST:1;this.avatarPos.x=Math.min(h.width-p.avatarWidth,this.avatarPos.x+p.avatarSpeed*e*s)}this.isShooting=!1}this.shotDelay-=e;const a=p.getAxis(i.up,i.down,i.left,i.right);if(0!==a.x||0!==a.y){const t=p.clampNorm({x:a.x*p.reticleSpeed,y:a.y*p.reticleSpeed},p.reticleSpeed);this.reticlePos.x+=t.x*e,this.reticlePos.y+=t.y*e,i.dodgeRight}const l=this.avatarPos.x-h.offset;l>t.VIEWABLE_WIDTH*(2/3)&&h.scrollRight(e),l<t.VIEWABLE_WIDTH/3&&h.scrollLeft(e),this.reticlePos.x<h.offset+p.avatarWidth/2&&(this.reticlePos.x=h.offset+p.avatarWidth/2),this.reticlePos.x>h.offset+t.VIEWABLE_WIDTH-p.avatarWidth/2&&(this.reticlePos.x=h.offset+t.VIEWABLE_WIDTH-p.avatarWidth/2),this.reticlePos.y<p.avatarWidth/2&&(this.reticlePos.y=p.avatarWidth/2),this.reticlePos.y>t.VIEWABLE_HEIGHT-p.avatarHeight&&(this.reticlePos.y=t.VIEWABLE_HEIGHT-p.avatarHeight);const r=Object.assign({width:p.avatarWidth,height:p.avatarHeight},this.avatarPos);for(const t of n.alive())o({x:t.x+t.width/2,y:t.y+t.height/2},r)&&(t.die(),this.levelStats.items++);i.right?"right"!==this.facing&&(this.facing="right",this.currentAnimation=new s(this.imageSpec.animations.move,!1,!0)):i.left?"left"!==this.facing&&(this.facing="left",this.currentAnimation=new s(this.imageSpec.animations.move,!0,!0)):"front"!==this.facing&&(this.facing="front",this.currentAnimation=null)}draw(t,e,s){this.drawScore(t,e),this.drawLives(t,e),this.wasKilled||(t.strokeStyle=this.isShooting?"lime":"red",t.beginPath(),this.gun.drawReticle(t,e,this.reticlePos.x-s,this.reticlePos.y),this.drawAvatar(t,e,s))}drawAvatar(t,e,s){const i=t.globalAlpha;this.invincibleTimer>0&&this.invincibleTimer%.5>.2&&(t.globalAlpha=.01);const h=Math.round(this.avatarPos.x-s),a=Math.round(this.avatarPos.y);null===this.currentAnimation?t.drawImage(e[this.imageSpec.id],this.imageSpec.sx,this.imageSpec.sy,this.imageSpec.sWidth,this.imageSpec.sHeight,h,a,this.imageSpec.sWidth,this.imageSpec.sHeight):this.currentAnimation.draw(t,e,h,a),t.globalAlpha=i}drawScore(t,e){const s=t.textAlign,i=t.oldFont;t.fillStyle="white",t.font="16px sans",t.textAlign="right";const h=this.score.toString().padStart(8,"0");t.fillText(h,Math.round(t.canvas.width/3.5),16),t.textAlign=s,t.font=i}drawLives(t,e){const s=t.textAlign,i=t.oldFont;t.textAlign="left",t.font="10px sans",t.fillStyle="pink",t.fillText("1P:",4,16),t.font="bold 12px sans",t.fillStyle="white",t.fillText(this.lives.toString(),24,16),t.textAlign=s,t.font=i}blast(t,e){for(;this.blastQueue.length>0;){const s=this.blastQueue.pop(),i=t.createBufferSource();i.buffer=e[s],i.connect(t.destination),i.start()}}takeShot(t,e){this.lives<=0||this.wasKilled||this.invincibleTimer>0||(this.blastQueue.push("playerDeath"),this.die())}die(){this.lives--,this.wasKilled=!0,this.currentAnimation=void 0===this.imageSpec.animations.death?null:new s(this.imageSpec.animations.death)}}class m{constructor(){this.timeBetweenShots=1/9,this.speed=8,this.damage=10,this.imageSpec={id:"bullets",sx:1,sy:1,sWidth:8,sHeight:8},this.bulletWidth=p.avatarWidth/4,this.bulletHeight=p.avatarWidth/4,this.shootingSound="playerShooting1"}fire(t,e,s,i){return[h.spawn(t,e,this.bulletWidth,this.bulletHeight,this.imageSpec,s,this.speed,this.damage,i)]}drawReticle(t,e,s,i){t.arc(Math.round(s),Math.round(i),Math.round(p.avatarWidth/2),0,2*Math.PI),t.stroke()}}class y extends m{constructor(){super(),this.timeBetweenShots=.2,this.speed=10,this.damage=6,this.imageSpec={id:"bullets",sx:1,sy:1,sWidth:8,sHeight:8},this.bulletWidth=p.avatarWidth/5,this.bulletHeight=p.avatarWidth/5,this.shootingSound="explosion2"}fire(t,e,s,i){return[h.spawn(t,e,this.bulletWidth,this.bulletHeight,this.imageSpec,{x:s.x-4,y:s.y-2,width:s.width,height:s.height},this.speed,this.damage,i),h.spawn(t,e,this.bulletWidth,this.bulletHeight,this.imageSpec,{x:s.x+4,y:s.y-2,width:s.width,height:s.height},this.speed,this.damage,i),h.spawn(t,e,this.bulletWidth,this.bulletHeight,this.imageSpec,{x:s.x-4,y:s.y+2,width:s.width,height:s.height},this.speed,this.damage,i),h.spawn(t,e,this.bulletWidth,this.bulletHeight,this.imageSpec,{x:s.x+4,y:s.y+2,width:s.width,height:s.height},this.speed,this.damage,i)]}drawReticle(t,e,s,i){t.strokeRect(Math.round(s),Math.round(i),Math.round(p.avatarWidth),Math.round(p.avatarWidth/1.5))}}class f{static#t=0;static#e=0;static#s=256;static#i=12;static BACKGROUNDS_MAP={graveyard:["graveyardBG"],default:["levelBG"]};constructor(t,e,s,i){this.levelData=t,this.backgrounds=f.BACKGROUNDS_MAP[t.name]||f.BACKGROUNDS_MAP.default,this.backgrounds.length<4&&(this.backgrounds=this.backgrounds.concat(Array(4-this.backgrounds.length).fill("transparentBG"))),this.width=e,this.offset=0,this.enemies=[],this.props=t.props.map((t=>a.spawn(t.x,t.y,t.width,t.height,t.imageSpec))),this.player=i,this.activeEntities=[],this.levelTimerDisabled=!1,this.finished=!1,this.maxTimeIndex=this.getMaxTimeIndex()}disableLevelTimer(){this.levelTimerDisabled=!0}getMaxTimeIndex(){return Math.max(...Object.values(this.levelData.walkways).map((t=>t.findLastIndex((t=>null!==t&&t.length>0)))))}reset(t){f.#t=0,f.#e=0,this.levelData=t,this.offset=0,this.enemies=[];for(const t of l())t.live=!1,t.needsUpdate=!1;for(const t of this.props)t.live=!0,t.needsUpdate=!0;this.levelTimerDisabled=!1,this.finished=!1,this.maxTimeIndex=this.getMaxTimeIndex()}scrollLeft(t){this.offset=Math.max(0,this.offset-f.#s*t)}scrollRight(e){this.offset=Math.min(this.offset+f.#s*e,this.width-t.VIEWABLE_WIDTH)}update(e){if(f.#t+=e,!this.levelTimerDisabled&&f.#i-f.#t<=0)return t.PRODUCTION||console.log("LEVEL FINISHED!!"),void(this.finished=!0);f.#e+=e;const s=Math.floor(1e3*f.#t/t.TIME_SLOT);if(Math.ceil(1e3*f.#e)>=t.TIME_SLOT){void 0===this.enemies[s-1]&&(this.enemies[s-1]=[]);for(const t of Object.keys(this.levelData.walkways).sort())for(const e of this.levelData.walkways[t][s-1]||[]){const i=Object.assign(e,d.KINDS[e.name]||{}),h=i.count||1;for(let e=0;e<h;e++){const h=i.endX+e*i.width,a=void 0===d.KINDS[i.kind]?d.KINDS[i.name].sfx:d.KINDS[i.kind].sfx,n=d.spawn(i.x+e*i.width,Number(t)-i.height,i.width,i.height,i.imageSpec,i.bounty,h,a,i.timeToAttack,i.timeToReturn);this.enemies[s-1].push(n)}}f.#e=0,s>this.maxTimeIndex&&Array.from(d.alive()).length<=0&&(f.#t=0,this.enemies=[])}for(let e=0;e<=s;e++){const s=f.#t-e*t.TIME_SLOT/1e3;for(const t of a.alive())t.update(s,this.player);if(void 0!==this.enemies[e])for(const t of this.enemies[e])t.needsUpdate&&t.update(s,this.player)}for(const t of n.alive())t.update(e);for(const t of h.alive())t.update(e);this.activeEntities=l()}drawBG(t,e){t.drawImage(e[this.backgrounds[0]],Math.round(this.offset/5),0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height),t.drawImage(e[this.backgrounds[1]],Math.round(this.offset/4)+12,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height),t.drawImage(e[this.backgrounds[2]],Math.round(this.offset/3)-13,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height),t.drawImage(e[this.backgrounds[3]],Math.round(this.offset/2)+7,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height)}draw(t,e){this.drawBG(t,e);for(const s of this.activeEntities)s.draw(t,e,this.offset);if(this.levelTimerDisabled)return;const s=t.textAlign,i=t.oldFont;t.fillStyle="white",t.font="bold 18px sans",t.textAlign="center";const h=Math.round(f.#i-f.#t).toString().padStart(2,"0");t.fillText(h,Math.round(t.canvas.width/2),16),t.textAlign=s,t.font=i}blast(t,e){for(const s of this.activeEntities)s.blast(t,e)}}class x extends f{static classMap={unibrain:g,witch:u,default:g};constructor(t,e,s,i){super(t,e,s,i);const h=x.classMap[t.boss||"default"];this.bossPos={x:10,y:s/2},this.boss=new h(this.bossPos.x,this.bossPos.y,1e3),this.timer=0,this.player.setBoss(this.boss)}reset(t){const e=x.classMap[t.boss||"default"];this.boss=new e(this.bossPos.x,this.bossPos.y,1e3),this.timer=0,this.finished=!1,this.player.setBoss(this.boss)}update(t){this.timer+=t,this.boss.update(this.timer,this.player);for(const e of h.alive())e.update(t);this.boss.live||this.boss.needsUpdate||(this.finished=!0,this.player.unsetBoss()),this.activeEntities=[this.boss].concat(Array.from(h.alive()))}}class v{constructor(t,e,s,i,h,a,n){this.x=t,this.y=e,this.width=s,this.height=i,this.spriteOffsetX=h,this.spriteOffsetY=a,this.mouseBtnWasHeld=!1,this.flipSprite=n||!1}onClick(t){this.action=t}update(t,e){const s=o(e.mousePos,{x:this.x,y:this.y,width:this.width,height:this.height});s&&!e.mouseButtonHeld&&this.mouseBtnWasHeld&&this.action(),this.mouseBtnWasHeld=s&&e.mouseButtonHeld}draw(t,e){if(this.flipSprite?(t.translate(this.x+this.width,this.y),t.scale(-1,1),t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,0,0,this.width,this.height),t.setTransform(1,0,0,1,0,0)):t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,this.x,this.y,this.width,this.height),this.mouseBtnWasHeld){const e=t.globalAlpha;t.globalAlpha=.3,t.fillStyle="white",t.fillRect(this.x+1,this.y+1,this.width-2,this.height-2),t.globalAlpha=e}}}class w extends v{static WIDTH=17;static HEIGHT=16;constructor(t,e,s,i,h){super(Math.floor(i/2)*w.WIDTH,i%2*w.HEIGHT+h,w.WIDTH,w.HEIGHT,e,s,!1),this.editor=t,this.order=i}action(){t.PRODUCTION||console.log("CLICKED",this)}}class S extends w{constructor(t,e,s){super(t,0,0,e,s)}action(){this.editor.toggle()}}class b extends w{constructor(t,e,s){super(t,2*w.WIDTH,0,e,s)}action(){this.editor.chainSelected()}}class T extends w{constructor(t,e,s){super(t,3*w.WIDTH,0,e,s)}action(){this.editor.undo()}}class W extends w{constructor(t,e,s){super(t,w.WIDTH,w.HEIGHT-1,e,s)}action(){this.editor.addWalkWay()}}class E extends w{constructor(t,e,s){super(t,2*w.WIDTH,w.HEIGHT,e,s)}action(){this.editor.deleteSelected()}}class I extends w{constructor(t,e,s){super(t,3*w.WIDTH,w.HEIGHT,e,s)}action(){this.editor.save().then((()=>alert("Level saved correctly")))}}const A=Object.entries(d.KINDS).map((([t,e])=>({type:"enemy",name:t,width:e.imageSpec.sWidth,height:e.imageSpec.sHeight,imageSpec:e.imageSpec}))),H=Object.entries(a.KINDS).map((([t,e])=>({type:"prop",name:t,width:e.imageSpec.sWidth,height:e.imageSpec.sHeight,imageSpec:e.imageSpec})));class D{static buttonSpecs=[S,E,b,W,T,I];static WP_HANDLE_SIZE=8;static WING_WIDTH=64;static WALKWAY_COVER_DISTANCE=8;static#h=["graveyard"];constructor(e,s){this.enabled=!0,this.hooks=s,this.components={timeSlider:new P(this),enemyPalette:new O(this,w.WIDTH*D.buttonSpecs.length/2,184+P.HEIGHT,144,236,A),propPalette:new O(this,w.WIDTH*D.buttonSpecs.length/2+144,184+P.HEIGHT,t.VIEWABLE_WIDTH-(w.WIDTH*D.buttonSpecs.length/2+144),236,H),stageSlider:new k(this)};const i=this.components.timeSlider.y+P.HEIGHT,h=this;this.buttons=D.buttonSpecs.map(((t,e)=>new t(h,e,i))),this.dragObj={},this.dragWP={},this.dragWW=null,this.newWalkWay=null,this.enemyWalkWay=null,this.isAddingWalkWay=!1,this.selectedWalkWay=null,this.isDragging=!1,this.isDraggingWP=!1,this.isDraggingWW=!1,this.stageOffset=0,this.dragOffset={x:0,y:0},this.selectedEnemy=null,this.selectedProp=null,this.simEnemies=[],this.undoList=[],this.levels=e,this.currentLevelIdx=0;const a=Object.keys(this.levels)[this.currentLevelIdx];this.levelData=e[a]||{props:[],walkways:{150:[]}}}scrollRight(e){this.stageOffset+=e,this.stageOffset=Math.min(this.stageOffset,t.PLAYABLE_WIDTH-t.VIEWABLE_WIDTH+D.WING_WIDTH)}scrollLeft(t){this.stageOffset-=t,this.stageOffset=Math.max(this.stageOffset,-D.WING_WIDTH)}update(s,i){if(i.justReleasedKeys.has(e.EDIT))return void this.toggle();if(i.justReleasedKeys.has("Escape"))return void this.exit();const h=Object.values(this.levels);if(i.justReleasedKeys.has("PageDown"))return this.currentLevelIdx=(this.currentLevelIdx+1)%h.length,this.levelData=h[this.currentLevelIdx],t.PRODUCTION||console.log("CHANGED TO LEVEL",Object.keys(this.levels)[this.currentLevelIdx]),this.selectedWalkWay=null,this.selectedEnemy=null,void(this.selectedProp=null);if(i.justReleasedKeys.has("PageUp"))return this.currentLevelIdx--,this.currentLevelIdx<0?this.currentLevelIdx=h.length+this.currentLevelIdx:this.currentLevelIdx%=h.length,this.levelData=h[this.currentLevelIdx],t.PRODUCTION||console.log("CHANGED TO LEVEL",Object.keys(this.levels)[this.currentLevelIdx]),this.selectedWalkWay=null,this.selectedEnemy=null,void(this.selectedProp=null);const a=i.mousePos.x,n=i.mousePos.y;if(this.getTimeIndex(),this.isAddingWalkWay)this.newWalkWay=n,i.mouseButtonHeld&&(this.isAddingWalkWay=!1,void 0===this.levelData.walkways&&(this.levelData.walkways=[]),this.newWalkWay<this.components.timeSlider.y?this.levelData.walkways[Math.round(this.newWalkWay)]=[]:t.PRODUCTION||console.log("Dropped walkway outside of gameplay area"),this.newWalkWay=null);else if(!this.isDragging&&!this.isDraggingWP&&i.mouseButtonHeld&&(n<this.components.timeSlider.y||n>this.components.timeSlider.y+P.HEIGHT)){const t=o(i.mousePos,this.components.enemyPalette.innerRect)||o(i.mousePos,this.components.propPalette.innerRect);if(t){const t=this.components.enemyPalette.boxes.concat(this.components.propPalette.boxes);for(const e of t)if(o(i.mousePos,e)){this.isDragging=!0,this.dragObj={x:e.x,y:e.y,width:e.entity.width,height:e.entity.height,entity:Object.assign({},e.entity),new:!0},this.dragOffset.x=this.dragObj.x-a,this.dragOffset.y=this.dragObj.y-n;break}}else{for(const[t,e,s]of this.getEnemiesForTime()){const i={x:s.endX?s.endX:s.x+s.width/2-D.WP_HANDLE_SIZE/2,y:s.y+s.height/2-D.WP_HANDLE_SIZE/2,width:D.WP_HANDLE_SIZE,height:D.WP_HANDLE_SIZE};if(o({x:a+this.stageOffset,y:n},i)){this.isDraggingWP=!0,Object.assign(this.dragWP,{walkway:e,index:this.getTimeIndex(),subindex:t,start:{x:s.x+s.width/2-this.stageOffset,y:s.y+s.height/2},end:{x:a-this.stageOffset,y:s.y+s.height/2}});break}if(o({x:a+this.stageOffset,y:n},{x:s.x,y:s.y,width:s.width*(s.count||1),height:s.height})){this.isDragging=!0,Object.assign(this.dragObj,{x:s.x,y:s.y,width:s.width,height:s.height,entity:s,endX:s.x+this.stageOffset+s.width,subindex:t,oldWW:e}),this.dragObj.new=!1,this.dragOffset.x=this.dragObj.x-a-this.stageOffset,this.dragOffset.y=this.dragObj.y-n;break}}if(!this.isDragging)for(const[t,e]of this.levelData.props.entries())if(o({x:a+this.stageOffset,y:n},e)){this.isDragging=!0,Object.assign(this.dragObj,{x:e.x,y:e.y,width:e.width,height:e.height,entity:e,index:t,new:!1}),this.dragOffset.x=this.dragObj.x-a-this.stageOffset,this.dragOffset.y=this.dragObj.y-n;break}}if(!(t||this.isDragging||this.isDraggingWP||this.isDraggingWW))for(const t of Object.keys(this.levelData.walkways))if(n>t-10&&n<t){this.isDraggingWW=!0,this.dragWW={y:t,old:t},this.dragOffset.y=t-n;break}}for(const t of Object.values(this.components))t.update(s,i);for(const[t,e]of this.buttons.entries())e.update(s,i);if(this.isDraggingWP)i.mouseButtonHeld?this.dragWP.end.x=i.mousePos.x:(this.isDraggingWP=!1,this.dragWP.end.x>0&&this.dragWP.end.x<t.VIEWABLE_WIDTH&&this.dropWP());else if(this.isDragging)if(i.mouseButtonHeld){this.dragObj.x=i.mousePos.x+this.dragOffset.x+this.stageOffset,this.dragObj.y=i.mousePos.y+this.dragOffset.y;let t=Number.MAX_SAFE_INTEGER;for(const e of Object.keys(this.levelData.walkways))Math.abs(e-n)<=Math.abs(t-n)&&(t=e);this.enemyWalkWay=t}else this.isDragging=!1,this.dragObj.x>-D.WING_WIDTH&&this.dragObj.x+this.dragObj.width<t.PLAYABLE_WIDTH+D.WING_WIDTH&&this.dropEntity();else if(this.isDraggingWW)if(i.mouseButtonHeld)this.dragWW.y=i.mousePos.y+this.dragOffset.y;else{if(this.dragWW.y<this.components.timeSlider.y){if(this.dragWW.old!==this.dragWW.y.toString()){this.undoList.push(this.takeDataSnapshot()),this.levelData.walkways[this.dragWW.y.toString()]=this.levelData.walkways[this.dragWW.old].map((t=>(t||[]).map((t=>(t.y=this.dragWW.y-t.height,t))))),delete this.levelData.walkways[this.dragWW.old];for(const t of this.levelData.props.filter((t=>t.y==this.dragWW.old-t.height+D.WALKWAY_COVER_DISTANCE)))t.y=this.dragWW.y-t.height+D.WALKWAY_COVER_DISTANCE;this.updateSimEnemies(this.getTimeIndex())}this.selectedWalkWay=this.dragWW.y.toString(),this.selectedEnemy=null,this.selectedProp=null}else t.PRODUCTION||console.log("Dropped walkway outside of gameplay area");this.isDraggingWW=!1,this.dragWW=null}}updateSimEnemies(e){this.simEnemies=[];for(const[s,i]of Object.entries(this.levelData.walkways))for(let h=0;h<e;h++){const a=i[h];if(void 0===a)continue;const n=(e-h)*t.TIME_SLOT;for(const t of a||[]){const e=t.count||1;for(let i=0;i<e;i++){const e=d.spawn(t.x+t.width*i,Number(s)-t.height,t.width,t.height,t.imageSpec,t.bounty,t.endX+t.width*i);e.attacked=!0,e.update(n/1e3),this.simEnemies.push(e)}}}}getTimeIndex(){return this.components.timeSlider.sliderPos}addEnemy(t,e,s){return null==s&&(s=this.getTimeTimeIdx()),void 0!==this.levelData.walkways[t][s]&&null!==this.levelData.walkways[t][s]||(this.levelData.walkways[t][s]=[]),this.levelData.walkways[t][s].push(e)-1}addProp(t){return this.levelData.props.push(t)-1}deleteProp(t){this.levelData.props.splice(t,1)}dropEntity(){this.undoList.push(this.takeDataSnapshot());const t=this.dragObj.entity;switch(t.x=this.dragObj.x,t.type){case"enemy":{t.y=Number(this.enemyWalkWay)-t.height;const e=this.getTimeIndex();this.selectedEnemy={enemy:t,index:e,walkway:this.enemyWalkWay},this.selectedWalkWay=null,this.dragObj.new||this.deleteEnemy(this.dragObj.oldWW,e,this.dragObj.subindex),this.selectedEnemy.subindex=this.addEnemy(this.enemyWalkWay,t,e),this.enemyWalkWay=null,this.selectedProp=null;break}case"prop":{Math.abs(this.dragObj.y-Number(this.enemyWalkWay))<1.5*t.height?t.y=Number(this.enemyWalkWay)-t.height+D.WALKWAY_COVER_DISTANCE:t.y=this.dragObj.y,this.dragObj.new||this.deleteProp(this.dragObj.index);const e=this.addProp(t);this.selectedEnemy=null,this.enemyWalkWay=null,this.selectedProp={prop:t,index:e};break}default:console.error("Unknown entity type",t)}}dropWP(){this.undoList.push(this.takeDataSnapshot());const t=this.levelData.walkways[this.dragWP.walkway][this.dragWP.index][this.dragWP.subindex];t.endX=this.dragWP.end.x+this.stageOffset,this.selectedEnemy={enemy:t,walkway:this.dragWP.walkway,index:this.dragWP.index,subindex:this.dragWP.subindex},this.selectedWalkWay=null,this.selectedProp=null}takeDataSnapshot(){const e={name:Object.keys(this.levels)[this.currentLevelIdx],props:(this.levelData.props||[]).map((t=>({...t}))),walkways:JSON.parse(JSON.stringify(this.levelData.walkways))};return t.PRODUCTION||console.log("Took data snapshot",e),e}*getEnemiesForTime(){const t=this.getTimeIndex();for(const e of Object.keys(this.levelData.walkways).sort()){const s=this.levelData.walkways[e][t]||[];for(const[t,i]of s.entries())yield[t,e,i]}}drawEntity(t,e,s,i){i=i||0;const h=t.imageSpec;e.drawImage(s[h.id],h.sx,h.sy,h.sWidth,h.sHeight,Math.round(t.x-this.stageOffset+i*t.width),Math.round(t.y),t.width,t.height)}draw(t,e){const s=t.globalAlpha,i=Object.keys(this.levels)[this.currentLevelIdx],h=e[(f.BACKGROUNDS_MAP[i]||f.BACKGROUNDS_MAP.default)[0]];t.drawImage(h,this.stageOffset,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height);for(const e of Object.keys(this.levelData.walkways)){t.globalAlpha=.6,e===this.enemyWalkWay?t.fillStyle="fuchsia":e===this.selectedWalkWay?(t.globalAlpha=.8,t.fillStyle="lime"):t.fillStyle="indianred",t.fillRect(0,Math.round(e)-10,t.canvas.width,10),t.fillStyle="white",t.globalAlpha=.9;const i=this.levelData.walkways[e].flat().filter((t=>null!==t)).reduce(((t,e)=>t+(e.count||1)),0);t.fillText(i.toString(),2,Math.round(e)-1),t.globalAlpha=s}this.isAddingWalkWay&&null!==this.newWalkWay&&(t.fillStyle="hotpink",t.fillRect(0,Math.round(this.newWalkWay)-10,t.canvas.width,10));for(const[s,i,h]of this.getEnemiesForTime()){const s=h.count||1;for(let i=0;i<s;i++)this.drawEntity(h,t,e,i);const i=h.y+h.height/2;h.endX?(t.strokeStyle="yellow",t.beginPath(),t.moveTo(Math.round(h.x-this.stageOffset+h.width*(h.count||1)/2),Math.round(h.y+h.height/2)),t.lineTo(Math.round(h.endX-this.stageOffset),Math.round(i)),t.stroke(),t.strokeStyle="cyan",t.strokeRect(Math.round(h.endX-this.stageOffset-D.WP_HANDLE_SIZE/2),Math.round(i-D.WP_HANDLE_SIZE/2),D.WP_HANDLE_SIZE,D.WP_HANDLE_SIZE)):t.strokeRect(Math.round(h.x-this.stageOffset+h.width/2-D.WP_HANDLE_SIZE/2),Math.round(i-D.WP_HANDLE_SIZE/2),D.WP_HANDLE_SIZE,D.WP_HANDLE_SIZE)}const a=this.getTimeIndex();t.globalAlpha=.3;for(const s of this.simEnemies)this.drawEntity(s,t,e);t.globalAlpha=s;for(const s of Object.keys(this.levelData.walkways).map(Number).sort(((t,e)=>t-e)).map((t=>t.toString())))for(const i of this.levelData.props.filter((t=>t.y<Number(s))))this.drawEntity(i,t,e);for(const s of Object.values(this.components))s.draw(t,e);if(this.isDraggingWP&&(t.strokeStyle="red",t.beginPath(),t.moveTo(this.dragWP.start.x,this.dragWP.start.y),t.lineTo(this.dragWP.end.x,this.dragWP.end.y),t.stroke()),this.isDragging){t.fillStyle=this.dragObj.entity.color;const s=t.globalAlpha;t.globalAlpha=.5,this.drawEntity(this.dragObj.entity,t,e),t.globalAlpha=s}for(const[s,i]of this.buttons.entries())i.draw(t,e,this.components.timeSlider.y+P.HEIGHT,s);null!==this.selectedEnemy&&a===this.selectedEnemy.index&&(t.setLineDash([2,3]),t.strokeStyle="lime",t.strokeRect(Math.round(this.selectedEnemy.enemy.x-this.stageOffset),Math.round(this.selectedEnemy.enemy.y),this.selectedEnemy.enemy.width*(this.selectedEnemy.enemy.count||1),this.selectedEnemy.enemy.height),t.setLineDash([])),null!==this.selectedProp&&(t.setLineDash([2,3]),t.strokeStyle="lime",t.strokeRect(Math.round(this.selectedProp.prop.x-this.stageOffset),Math.round(this.selectedProp.prop.y),this.selectedProp.prop.width,this.selectedProp.prop.height),t.setLineDash([])),this.isDragging&&(t.setLineDash([2,3]),t.strokeStyle="pink",t.strokeRect(Math.round(this.dragObj.x-this.stageOffset),Math.round(this.dragObj.y),this.dragObj.width*(this.dragObj.entity.count||1),this.dragObj.height),t.setLineDash([])),this.isDraggingWW&&(t.globalAlpha=.8,t.fillStyle="lime",t.fillRect(0,Math.round(this.dragWW.y)-10,t.canvas.width,10),t.globalAlpha=s)}blast(t,e){}toggle(){this.enabled=!this.enabled,this.enabled?(this.updateSimEnemies(this.components.timeSlider.sliderPos),this.hooks.edit(this.levelData)):this.hooks.play(this.takeDataSnapshot())}exit(){this.hooks.exit()}deleteEnemy(t,e,s){Array.isArray(this.levelData.walkways[t][e])&&this.levelData.walkways[t][e].splice(s,1)}deleteSelected(){null!==this.selectedEnemy&&this.getTimeIndex()===this.selectedEnemy.index?(this.undoList.push(this.takeDataSnapshot()),this.deleteEnemy(this.selectedEnemy.walkway,this.selectedEnemy.index,this.selectedEnemy.subindex),this.selectedEnemy=null,t.PRODUCTION||console.log("DATA UPDATED",this.levelData,this.undoList)):null!==this.selectedProp?(this.undoList.push(this.takeDataSnapshot()),this.deleteProp(this.selectedProp.index),this.selectedProp=null):null!==this.selectedWalkWay&&(this.undoList.push(this.takeDataSnapshot()),delete this.levelData.walkways[this.selectedWalkWay],this.selectedWalkWay=null)}undo(){if(this.undoList.length){const t=this.undoList.pop();this.levelData=t,this.selectedEnemy=null,this.selectedWalkWay=null}else t.PRODUCTION||console.log("No further undo information")}chainSelected(){if(null!==this.selectedEnemy&&this.getTimeIndex()===this.selectedEnemy.index){const t=this.selectedEnemy.walkway,e=this.selectedEnemy.index,s=this.selectedEnemy.subindex;this.undoList.push(this.takeDataSnapshot());const i=this.levelData.walkways[t][e][s];i.count=(i.count||1)+1}}async save(){const t=await window.showSaveFilePicker({suggestedName:`${Object.keys(this.levels)[this.currentLevelIdx]}.json`}),e=await t.createWritable(),s=JSON.stringify(this.takeDataSnapshot(),null,2),i=new Blob([s],{type:"application/json"});return await e.write(i),await e.close(),s}addWalkWay(){this.isAddingWalkWay||(this.isAddingWalkWay=!0,this.newWalkWay=null)}}class k{static btnSize=11;constructor(e){this.editor=e,this.slidePos=0,this.leftBtn={x:0,y:t.VIEWABLE_HEIGHT-k.btnSize,width:k.btnSize,height:k.btnSize},this.rightBtn={x:t.VIEWABLE_WIDTH-k.btnSize,y:t.VIEWABLE_HEIGHT-k.btnSize,width:k.btnSize,height:k.btnSize},this.mouseHeldOnLeftBtn=!1,this.mouseHeldOnRightBtn=!1}update(t,e){const s=o(e.mousePos,this.leftBtn);s&&!e.mouseButtonHeld&&this.mouseHeldOnLeftBtn&&this.editor.scrollLeft(20),this.mouseHeldOnLeftBtn=s&&e.mouseButtonHeld;const i=o(e.mousePos,this.rightBtn);i&&!e.mouseButtonHeld&&this.mouseHeldOnRightBtn&&this.editor.scrollRight(20),this.mouseHeldOnRightBtn=i&&e.mouseButtonHeld}draw(t,e){const s=t.canvas.height-k.btnSize;t.drawImage(e.editorUI,74,0,k.btnSize,k.btnSize,0,s,k.btnSize,k.btnSize),t.translate(t.canvas.width,s),t.scale(-1,1),t.drawImage(e.editorUI,74,0,k.btnSize,k.btnSize,0,0,k.btnSize,k.btnSize),t.setTransform(1,0,0,1,0,0)}}class P{static SPEED=2;static MAX_TIME=1e5;static HEIGHT=12;static BTN_WIDTH=7;static TIME_STEP=250;constructor(e){this.editor=e,this.sliderPos=0,this.containerY=240-P.HEIGHT,this.y=184,this.isDragging=!1,this.maxPos=(t.VIEWABLE_WIDTH-P.BTN_WIDTH)/2,this.leftBtn=new v(0,this.y,P.BTN_WIDTH,P.HEIGHT,74,20),this.leftBtn.onClick((()=>this.stepLeft())),this.rightBtn=new v(t.VIEWABLE_WIDTH-P.BTN_WIDTH,this.y,P.BTN_WIDTH,P.HEIGHT,74,20,!0),this.rightBtn.onClick((()=>this.stepRight()))}getSelectedTime(){return this.sliderPos*P.TIME_STEP}updateSliderPos(e){this.sliderPos=e,t.PRODUCTION||console.log("Changed time slider position",this.sliderPos,"TIME:",this.getSelectedTime()),this.editor.updateSimEnemies(this.sliderPos)}stepLeft(){this.updateSliderPos(Math.max(0,this.sliderPos-1))}stepRight(){this.updateSliderPos(Math.min(this.maxPos,this.sliderPos+1))}screenPosToSliderPos(t){return Math.min(P.MAX_TIME/P.TIME_STEP,Math.max(0,Math.floor((t-P.BTN_WIDTH)/2)))}update(e,s){this.editor.isDragging||(this.leftBtn.update(e,s),this.rightBtn.update(e,s),s.left&&this.stepLeft(),s.right&&this.stepRight(),s.mouseButtonHeld&&s.mousePos.y>=this.y&&s.mousePos.y<=this.y+P.HEIGHT&&s.mousePos.x>P.BTN_WIDTH&&s.mousePos.x<t.VIEWABLE_WIDTH-P.BTN_WIDTH?(this.updateSliderPos(this.screenPosToSliderPos(s.mousePos.x)),this.isDragging=!0):!s.mouseButtonHeld&&this.isDragging&&(this.isDragging=!1,this.updateSliderPos(this.screenPosToSliderPos(s.mousePos.x))))}draw(t,e){this.leftBtn.draw(t,e);for(let s=P.BTN_WIDTH;s<t.canvas.width-P.BTN_WIDTH;s+=2)t.drawImage(e.editorUI,81,20,2,P.HEIGHT,s,this.y,2,P.HEIGHT);this.rightBtn.draw(t,e),t.fillStyle="red";for(const e of Object.values(this.editor.levelData.walkways))for(const[s,i]of e.entries())(i||[]).length&&t.fillRect(Math.floor(2*s)+P.BTN_WIDTH,this.y+2,1,6);t.fillStyle="yellow",t.fillRect(Math.floor(2*this.sliderPos)+P.BTN_WIDTH,this.y+2,1,6)}}class O{static boxSize=32;static scrollBtnWidth=6;static margin=4;constructor(t,e,s,i,h,a){this.editor=t,this.x=e,this.y=s,this.width=i,this.height=h,this.entitySpecs=a,this.innerRect={x:this.x+O.scrollBtnWidth,y:this.y,width:this.width-2*O.scrollBtnWidth,height:this.height},this.boxes=[],this.isDragging=!1,this.dragObj={},this.offset=0;const n=Math.round(.6*O.boxSize);this.leftScrollBtn=new v(this.x,this.y,O.scrollBtnWidth,32,85,0,!1),this.leftScrollBtn.onClick((()=>{this.offset-=n,this.offset=Math.max(this.offset,0),this.updateBoxes()})),this.rightScrollBtn=new v(this.x+this.width-O.scrollBtnWidth,this.y,O.scrollBtnWidth,32,85,0,!0),this.rightScrollBtn.onClick((()=>{this.offset+=n,this.offset=Math.min(this.offset,O.boxSize*this.boxes.length-this.innerRect.width),this.updateBoxes()})),this.updateBoxes()}updateBoxes(){this.boxes=this.entitySpecs.map(((t,e)=>({x:this.x+10+e*O.boxSize-this.offset,y:this.y+O.margin,width:O.boxSize-2*O.margin,height:O.boxSize-2*O.margin,entity:t})))}update(t,e){this.leftScrollBtn.update(t,e),this.rightScrollBtn.update(t,e)}draw(t,e){t.fillStyle="black",t.fillRect(this.x+O.scrollBtnWidth,this.y,O.boxSize*this.boxes.length,O.boxSize);for(const[s,i]of this.boxes.entries()){if(i.x+i.width<this.x+O.scrollBtnWidth||i.x>this.x+this.width)continue;const h=s*O.boxSize-this.offset,a=i.entity.imageSpec;let n=0;i.x<this.x+O.scrollBtnWidth?n=this.x+O.scrollBtnWidth-i.x-O.margin:i.x+i.width>this.x+this.width?n=this.x+this.width-i.width-i.x+O.margin:(t.drawImage(e.editorUI,71,0,3,O.boxSize,Math.round(this.x+O.scrollBtnWidth+h),this.y,3,O.boxSize),t.drawImage(e.editorUI,68,0,3,O.boxSize,Math.round(this.x+O.scrollBtnWidth+(s+1)*O.boxSize-3-this.offset),this.y,3,O.boxSize)),t.drawImage(e[a.id],a.sx+n,a.sy,a.sWidth-n,a.sHeight,Math.round(i.x+n),Math.round(i.y),i.width-n,i.height)}this.leftScrollBtn.draw(t,e),this.rightScrollBtn.draw(t,e)}}const _={images:[{id:"player1Portrait",path:"images/lama_sideview_avatar.png"},{id:"player1Back",path:"images/sprite_1gun shoot.png"},{id:"player1Side",path:"images/Sprite1 Wip/RUN_Concept_1.png"},{id:"player2",path:"images/julhilde.png"},{id:"tile",path:"images/tile.png"},{id:"levelBG",path:"images/background2.png"},{id:"levelBG2",path:"images/background2.gif"},{id:"levelBG3",path:"images/background3.gif"},{id:"levelBG4",path:"images/background4.gif"},{id:"transparentBG",path:"images/background-transparent.gif"},{id:"graveyardBG",path:"images/mountaingraveyard23final.png"},{id:"editorUI",path:"images/editorUI.png"},{id:"donutSheet",path:"images/donut.png"},{id:"expressoGangsterSheet",path:"images/expressoGangster.png"},{id:"printerSheet",path:"images/printer.png"},{id:"graveyardProps",path:"images/graveyardObjects.png"},{id:"bullets",path:"images/playerBullet-10x10.png"},{id:"gems",path:"images/gems.png"},{id:"toaster",path:"images/toasterBat.png"},{id:"logo",path:"images/logo.png"},{id:"menuBG",path:"images/menu_background.gif"},{id:"unibrain",path:"images/unibrain.png"},{id:"bullet_trail",path:"images/bullet_trail.png"},{id:"evilWitch",path:"images/witch.png"}],sounds:[{id:"playerShooting1",path:"sounds/player-shoot-1-WG.mp3"},{id:"playerShooting2",path:"sounds/player-shoot-2-WG.mp3"},{id:"playerDeath",path:"sounds/player_death.mp3"},{id:"donutDeath",path:"sounds/zombie-doughnut-death-short.mp3"},{id:"printerDeath",path:"sounds/possessed-printer-death-WG.mp3"},{id:"espressoDeath",path:"sounds/espresso-gangster-death-reverb.mp3"},{id:"enemyShoot",path:"sounds/enemy_shoot.wav"},{id:"printerShoot",path:"sounds/printer_shooting_2.mp3"},{id:"explosion1",path:"sounds/explode_1_WG.mp3"},{id:"explosion2",path:"sounds/explode_2_WG.mp3"},{id:"explosion3",path:"sounds/printer_shooting.mp3"},{id:"espressoAttack1",path:"sounds/espresso_shoot_1.mp3"},{id:"espressoAttack2",path:"sounds/espresso_shoot_2.mp3"},{id:"toasterAttack",path:"sounds/toaster_bat_shooting.mp3"},{id:"uniBrainAttack",path:"sounds/unicorn_brain_psionic_attack.mp3"},{id:"evilWitchAttack1",path:"sounds/witchboss_attack.mp3"},{id:"evilWitchAttack2",path:"sounds/witchboss_attack_2.mp3"},{id:"evilWitchDeath",path:"sounds/witchboss_death.mp3"}],levels:[{id:"graveyard",path:"levels/graveyard.json"},{id:"forest",path:"levels/level1.json"}]};class L{static dt=0;static updateStep=1/60;static last=window.performance&&window.performance.now?window.performance.now():(new Date).getTime();constructor(s,i){const h=document.getElementById("gameCanvas");this.ctx=h.getContext("2d"),this.audioCtx=i,this.assets=s,this.input=new e(h),this.editor=new D(s.levels,{play:e=>this.scene=new U(new p({x:100,y:t.VIEWABLE_HEIGHT-p.avatarHeight},p.player2ImageSpec,new y),e,this.editor),edit:t=>this.scene=this.editor,exit:()=>this.scene=this.menu});const a=new F({exit:()=>this.scene=this.menu});this.menu=new M({play:()=>this.scene=new G(this,this.assets.levels),editor:()=>this.scene=this.editor,credits:()=>this.scene=a}),this.scene=this.menu}start(){window.requestAnimationFrame(this.getAnimationFrameCallback())}update(t){this.scene.update(t,this.input),this.input.justReleasedKeys.clear()}draw(){if(this.ctx.fillStyle=this.editor.enabled?"green":"gray",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.scene.draw(this.ctx,this.assets.images),this.input.pause&&this.scene.canPause){const t=this.ctx.textAlign,e=this.ctx.oldFont;this.ctx.fillStyle="white",this.ctx.font="bold 18px sans",this.ctx.textAlign="center",this.ctx.fillText("PAUSED",Math.round(this.ctx.canvas.width/2),Math.round(this.ctx.canvas.height/2)),this.ctx.textAlign=t,this.ctx.font=e}}blast(){this.scene.blast(this.audioCtx,this.assets.sounds)}getAnimationFrameCallback(){const t=this;return function(e){for(L.dt+=Math.min(1,(e-L.last)/1e3);L.dt>L.updateStep;)L.dt-=L.updateStep,t.update(L.updateStep),t.blast();t.draw(),L.last=e,window.requestAnimationFrame(t.getAnimationFrameCallback())}}}window.onload=function(){const t=new AudioContext;(function(t){return Promise.all([Promise.all(_.images.map((t=>async function(t){const e=new Image;return e.src=t.path,await e.decode(),[t.id,e]}(t)))),Promise.all(_.sounds.map((e=>async function(t,e){const s=await fetch(t.path),i=await s.arrayBuffer(),h=await e.decodeAudioData(i);return[t.id,h]}(e,t)))),Promise.all(_.levels.map((t=>async function(t){try{const e=await fetch(t.path),s=await e.json();return[t.id,s]}catch(e){return console.error("Failed to load",t,", ERROR:",e),[t.id,{background:"levelBG",props:[],walkways:{}}]}}(t))))])})(t).then((([e,s,i])=>{new L({images:Object.fromEntries(e),sounds:Object.fromEntries(s),levels:Object.fromEntries(i)},t).start()}))};class M{constructor(t){this.options=t,this.selectedIndex=0}update(t,e){const s=Object.keys(this.options).length;if(e.justReleasedKeys.has("ArrowDown")&&(this.selectedIndex++,this.selectedIndex=this.selectedIndex%s),e.justReleasedKeys.has("ArrowUp")&&(this.selectedIndex--,this.selectedIndex<0?this.selectedIndex=s+this.selectedIndex:this.selectedIndex=this.selectedIndex%s),e.justReleasedKeys.has("Enter")||e.justReleasedKeys.has(" ")){const t=Object.keys(this.options)[this.selectedIndex];this.options[t]()}}draw(t,e){t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height);const s=Math.round(t.canvas.width/2);t.drawImage(e.menuBG,180*Math.cos(performance.now()/4e3)-180,0),t.drawImage(e.logo,s-e.logo.width/2,0),t.fillStyle="orange";const i=t.textAlign,h=t.oldFont;t.font="12px sans",t.textAlign="left";for(const[e,i]of Object.keys(this.options).entries())e==this.selectedIndex&&t.fillText("👉",s-48,Math.round(.5*t.canvas.height+12*e)),t.fillText(i.toUpperCase(),s-24,Math.round(.5*t.canvas.height+12*e));t.font="10px sans",t.fillText("- Left, Right: Move (Double tap to Dodge)",.1*t.canvas.width,.5*t.canvas.height+12*(Object.keys(this.options).length+1)),t.fillText("- Spacebar: Shoot",.1*t.canvas.width,.5*t.canvas.height+12*(Object.keys(this.options).length+2)),t.fillText("- Up, Down: Aim",.1*t.canvas.width,.5*t.canvas.height+12*(Object.keys(this.options).length+3)),t.fillText("- p or Tab: Pause",.1*t.canvas.width,.5*t.canvas.height+12*(Object.keys(this.options).length+4)),t.textAlign=i,t.font=h}blast(t,e){}}class B{constructor(t,e,s){this.player=t,this.parent=s,this.loadLevel(e)}loadLevel(e){this.level=new f(e,t.PLAYABLE_WIDTH,t.VIEWABLE_HEIGHT,this.player),this.level.reset(e)}update(e,s){if(!s.pause){if(this.level.update(e,s),this.level.finished)return t.PRODUCTION||console.log("LEVEL FINISHED",this.level),void this.onFinishedLevel();this.player.update(e,s,this.level),this.player.lives<=0&&this.onPlayerLost()}}draw(t,e){this.level.draw(t,e),this.player.draw(t,e,this.level.offset)}blast(t,e){this.level.blast(t,e),this.player.blast(t,e)}onFinishedLevel(){this.parent.bossFight()}onPlayerLost(){this.parent.gameOver()}}class R extends B{loadLevel(e){this.level=new x(e,t.PLAYABLE_WIDTH,t.VIEWABLE_HEIGHT,this.player),this.level.reset(e),this.canPause=!0}onFinishedLevel(){this.canPause=!1,this.parent.tallyUp()}}class N{constructor(t,e){this.parent=t,this.timer=0,this.stats=Object.assign({},e)}update(t,e){this.timer+=t,this.timer>3&&this.parent.loadNextLevel()}draw(t,e){t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="cyan";const s=t.textAlign,i=t.oldFont;t.textAlign="center",t.font="bold 24px serif";const h=Math.round(t.canvas.width/2);t.fillText("LEVEL FINISHED",h,24),t.textAlign="left",t.font="20px serif",t.fillText("KILLS",12,48),t.fillText("VANDALISM",12,64),t.fillText("ITEMS",12,80),t.textAlign="right";const a=t.canvas.width-16;t.fillText(this.stats.kills.toString(),a,48),t.fillText(this.stats.vandalism.toString(),a,64),t.fillText(this.stats.items.toString(),a,80),t.textAlign=s,t.oldFont=i}blast(t,e){}}class j{constructor(t){this.parent=t,this.selected="left"}update(e,s){if((s.justReleasedKeys.has("ArrowRight")||s.justReleasedKeys.has("d"))&&(this.selected="right"),(s.justReleasedKeys.has("ArrowLeft")||s.justReleasedKeys.has("a"))&&(this.selected="left"),s.justReleasedKeys.has("Enter")){const e="left"==this.selected?p.player1ImageSpec:p.player2ImageSpec,s="left"==this.selected?new m:new y;this.parent.setPlayer(new p({x:100,y:t.VIEWABLE_HEIGHT-p.avatarHeight},e,s)),this.parent.loadNextLevel()}}draw(t,e){t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalAlpha=.1,t.drawImage(e.menuBG,e.menuBG.width-t.canvas.width,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height),t.globalAlpha="left"==this.selected?1:.4,t.drawImage(e.player1Portrait,0,0,e.player1Portrait.width,e.player1Portrait.height,(t.canvas.width-100)/4,(t.canvas.height-96)/2,e.player1Portrait.width,e.player1Portrait.height),t.globalAlpha="right"==this.selected?1:.4,t.drawImage(e.player2,65,0,35,49,3*(t.canvas.width-70)/4,(t.canvas.height-98)/2,70,98),t.globalAlpha=1}blast(t,e){}}class G{constructor(t,e){this.game=t,this.levels=e,this.nextLevelIdx=0,this.playerSelect()}setPlayer(t){this.player=t}playerSelect(){this.subscene=new j(this)}bossFight(){this.canPause=!1,this.subscene=new R(this.player,this.subscene.level.levelData,this),t.PRODUCTION||console.log("BOSS FIGHT",this.subscene),this.canPause=!0}tallyUp(){this.canPause=!1,this.subscene=new N(this,this.player.levelStats)}gameOver(){this.canPause=!1,this.subscene=new X({exit:()=>this.game.scene=this.game.menu})}loadNextLevel(){if(this.canPause=!1,this.nextLevelIdx>=Object.keys(this.levels).length)this.subscene=new C(this);else{const t=Object.keys(this.levels)[this.nextLevelIdx];this.player.resetLevelStats(),this.subscene=new B(this.player,this.levels[t],this),this.canPause=!0,this.nextLevelIdx=this.nextLevelIdx+1}}rollCredits(){this.canPause=!1,this.subscene=new F({exit:()=>this.gameOver()})}update(t,e){this.subscene.update(t,e)}draw(t,e){this.subscene.draw(t,e)}blast(t,e){this.subscene.blast(t,e)}}class C{constructor(t){this.parent=t,this.timer=0}update(t,e){this.timer+=t,this.timer>6&&this.parent.rollCredits()}draw(t,e){t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="pink";const s=t.textAlign,i=t.oldFont;t.textAlign="center",t.font="bold 24px serif";const h=Math.round(t.canvas.width/2);t.fillText("YOU DID IT!",h,Math.round(t.canvas.height/2)-50),t.textAlign="left",t.font="16px sans",t.fillText("THANKS FOR DEFEATING THE EVIL WITCH.",10,Math.round(t.canvas.height/2)),t.fillText("LET'S GO FOR A BURGER....",10,Math.round(t.canvas.height/2)+20),t.fillText("HA! HA! HA! HA!",10,Math.round(t.canvas.height/2)+40),t.textAlign=s,t.oldFont=i}blast(t,e){}}class U extends B{constructor(t,e,s){super(t,e,s),this.level.disableLevelTimer()}update(t,s){s.justReleasedKeys.has(e.EDIT)?this.exit():super.update(t,s)}exit(){this.parent.toggle()}onPlayerLost(){this.player.lives=10}}class F{constructor(t){this.hooks=t,this.elapsedTime=0,this.lineHeight=13,this.scrollPaused=!1,this.contributorFont=`bold ${this.lineHeight}px serif`,this.contributionsFont=`normal ${this.lineHeight}px serif`,this.MAX_CREDITS_SCROLL_TIME=17,this.credits=[{contributor:"Gonzalo Delgado",contributions:"Project lead, core gameplay, custom level editor and related UI/format, level design, hitboxcollision system, enemy behaviors, assorted bug fixes, general asset integration, title screen, level timer, level names setup"},{contributor:"Vince McKeown",contributions:"Sprite art (donut variants with animations, printer enemy, graves, bushes, rocks, latnern, expresso gangster, toaster bat), visual effects, game over and game win scenes, destroyable props, pickups, item drop, scoring, animation system, boss fight, gun types"},{contributor:"FightEXP",contributions:"Player 1 sprite animation (move and shoot), level backgrounds (moon, mountain graveyard), art concepts (character, shot, run, llama side view)"},{contributor:"Patrick McKeown",contributions:"Sounds (gunfire and bomb variations, enemy defeated, explosions, printer shots, toaster bat, coffee cup, unicorn barin, player defeated, witchboss), player shot sprites"},{contributor:'Christer "McFunkypants" Kaitila',contributions:"Player dodge, parallax background, logo, player mode GUI, shot trails, shot alignment"},{contributor:"Chad Serrant",contributions:"Player sprite walking animation, pause toggle"},{contributor:"Liyi Zhang",contributions:"Player 2 sprite (front and side, cape removed)"},{contributor:"Abhishek @akhmin_ak",contributions:"Enemy shot sound effect"},{contributor:"H Trayford",contributions:"Credits wrap and scroll"},{contributor:" ",contributions:" "},{contributor:"Press ESC key for Main Menu",contributions:"Or use up/down arrows for manual scroll"}]}exit(){this.elapsedTime=0,this.hooks.exit()}update(t,e){e.justReleasedKeys.has("Escape")?this.exit():e.justReleasedKeys.has("ArrowDown")?(this.scrollPaused=!0,this.elapsedTime-=1.5):e.justReleasedKeys.has("ArrowUp")?(this.scrollPaused=!0,this.elapsedTime+=1.5):e.justReleasedKeys.has(" ")?this.scrollPaused=!this.scrollPaused:this.scrollPaused||(this.elapsedTime+=t),this.elapsedTime<0&&(this.elapsedTime=0),this.elapsedTime>this.MAX_CREDITS_SCROLL_TIME&&(this.elapsedTime=this.MAX_CREDITS_SCROLL_TIME)}draw(t,e){t.save(),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="orange",t.textAlign="center";const s=Math.round(t.canvas.width/2),i=Math.round(t.canvas.height/3)-this.lineHeight*this.elapsedTime*2.5;let h=0;for(let e=0;e<this.credits.length;e++){t.font=this.contributorFont;let a=i+this.lineHeight*h;if(a>t.canvas.height)break;a>0&&t.fillText(this.credits[e].contributor,s,Math.round(a)),h++;const n=this.performWordWrap(this.credits[e].contributions);t.font=this.contributionsFont;for(const e of n){const a=Math.round(i+this.lineHeight*h);if(a>t.canvas.height)break;a>0&&t.fillText(e,s,a),h++}h++}t.restore()}performWordWrap(t){if(t.length<50)return[t];const e=[];let s=t;for(;s.length>50;){const t=s.substring(0,50).lastIndexOf(" ");e.push(s.substring(0,t)),s=s.substring(t)}return e.push(s),e}blast(t,e){}}class X{constructor(t){this.hooks=t,this.timer=0}exit(){this.hooks.exit()}update(t,e){this.timer+=t,this.timer>4&&this.exit()}draw(t,e){t.fillStyle="firebrick",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="lightyellow",t.textAlign,t.oldFont,t.textAlign="center",t.font="bold 24px serif";const s=Math.round(t.canvas.width/2);t.fillText("GAME",s,Math.round(t.canvas.height/3)),t.fillText("OVER",s,Math.round(t.canvas.height/2))}blast(t,e){}}})();