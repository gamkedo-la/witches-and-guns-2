(()=>{"use strict";class t{static EDIT="e";constructor(t){this.up=this.down=this.left=this.right=this.shoot=!1,this.edit=!1,this.onReleaseHooks={},this.mousePos={x:null,y:null},this.mouseButtonHeld=!1;const e=this;document.addEventListener("keydown",(t=>e.keyPress(t))),document.addEventListener("keyup",(t=>e.keyRelease(t))),t.addEventListener("mousemove",(t=>e.updateMousePos(t))),t.addEventListener("mousedown",(t=>{e.mouseButtonHeld=!0})),t.addEventListener("mouseup",(t=>{e.mouseButtonHeld=!1}))}flipInputState(t,e){switch(t){case" ":this.shoot=e;break;case"ArrowLeft":this.left=e;break;case"ArrowRight":this.right=e;break;case"ArrowUp":this.up=e;break;case"ArrowDown":this.down=e;break;case"e":this.edit=e}}keyPress(t){t.defaultPrevented||t.repeat||"F12"!=t.key&&(t.preventDefault(),this.flipInputState(t.key,!0))}keyRelease(t){if(!t.defaultPrevented&&"F12"!=t.key){t.preventDefault(),this.flipInputState(t.key,!1);for(const e of this.onReleaseHooks[t.key]||[])e(t)}}onRelease(t,e){void 0===this.onReleaseHooks[t]?this.onReleaseHooks[t]=[e]:this.onReleaseHooks[t].push(e)}updateMousePos(t){const e=t.target.getBoundingClientRect(),s=t.target.width/e.width,i=t.target.height/e.height,h=document.documentElement;this.mousePos.x=s*(t.clientX-e.left-h.scrollLeft),this.mousePos.y=i*(t.clientY-e.top-h.scrollTop)}}class e{static#t=[];static alive=function*(){for(const t of this.#t)t.live&&(yield t)};static spawn(t,s,i,h){let o=this.#t.filter((t=>!t.live)).pop();return void 0===o?(o=new e(t,s,i,h),this.#t.push(o),console.log("Created new enemy",o)):(o.init(t,s,i,h),console.log("Recycled enemy",o)),o}constructor(t,e,s,i){this.init(t,e,s,i)}init(t,e,s,i){this.color=s,this.live=!0,this.x=t,this.y=e,this.updater=i}update(t){if(!this.live)return;this.timer+=t;const e=this.updater(this,t);this.x=e.x,this.y=e.y,this.live=e.live}draw(t){t.fillStyle=this.color,t.beginPath(),t.arc(Math.round(this.x),Math.round(this.y),10,0,2*Math.PI),t.closePath(),t.fill()}}class s{static#t=[];static get(t,e,i,h,o,a){const n=s.#t.filter((t=>!t.live));if(n.length)return n[0].recycle(t,e,i,h,o,a);{const n=new s(t,e,i,h,o,a);return s.#t.push(n),n}}constructor(t,e,s,i,h,o){this.#e(t,e,s,i,h,o)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.position.y-this.target.height<this.target.y&&(this.live=!1,this.hooks.forEach((e=>e(t,this))))}#e(t,e,s,i,h,o){return this.position=s,this.radius=e,this.target=i,this.velocity={x:t*(this.target.x-this.position.x),y:t*(this.target.y-this.position.y)},this.hooks=o,this.live=!0,this}recycle(t,e,s,i,h,o){return this.#e(t,e,s,i,h,o),this}draw(t,e){t.strokeStyle="yellow",t.beginPath();const s={x:this.position.y-4<this.target.y?this.target.x:this.position.x,y:this.position.y-4<this.target.y?this.target.y:this.position.y};t.arc(Math.round(s.x),Math.round(s.y),Math.round(this.radius),0,2*Math.PI),t.stroke()}}const i={TIME_SLOT:250,VIEWABLE_WIDTH:426,VIEWABLE_HEIGHT:240,PLAYABLE_WIDTH:800};Object.freeze(i);class h{static avatarHeight=32;static avatarWidth=8;static reticleSpeed=270;static avatarSpeed=120;static timeBetweenShots=1/9;static getAxis=function(t,e,s,i){let h={x:0,y:0};return t?h.y+=-1:e&&(h.y+=1),s?h.x+=-1:i&&(h.x+=1),h};static clampNorm=function(t,e){const s=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),i=Math.min(s,e)/s;return{x:i*t.x,y:i*t.y}};static onHitTarget=function(t,s){for(const t of e.alive())Math.sqrt(Math.pow(t.x-s.target.x,2)+Math.pow(t.y-s.target.y,2))<=16&&(t.live=!1)};constructor(t){this.avatarPos={x:100,y:t.y},this.reticlePos={x:t.x+4,y:t.y-100},this.shots=[],this.shotDelay=0,this.hitTargetHooks=[h.onHitTarget],this.isShooting=!1}update(t,e,o){this.shots=this.shots.filter((t=>t.live)),e.shoot?this.shotDelay<=0&&(this.isShooting=!0,this.shots.push(s.get(8,h.avatarWidth/2,{x:this.avatarPos.x+h.avatarWidth/2,y:this.avatarPos.y},{x:this.reticlePos.x,y:this.reticlePos.y,height:3},10,this.hitTargetHooks)),this.shotDelay=h.timeBetweenShots):(e.left&&(this.avatarPos.x-=h.avatarSpeed*t),e.right&&(this.avatarPos.x+=h.avatarSpeed*t),this.isShooting=!1,o.scroll(this.avatarPos.x)),this.shots.forEach((e=>e.update(t))),this.shotDelay-=t;const a=h.getAxis(e.up,e.down,e.left,e.right);if(0!==a.x||0!==a.y){const e=h.clampNorm({x:a.x*h.reticleSpeed,y:a.y*h.reticleSpeed},h.reticleSpeed);this.reticlePos.x+=e.x*t,this.reticlePos.y+=e.y*t}this.avatarPos.x<0&&(this.avatarPos.x=0),this.avatarPos.x>i.VIEWABLE_WIDTH-h.avatarWidth&&(this.avatarPos.x=i.VIEWABLE_WIDTH-h.avatarWidth),this.reticlePos.x<h.avatarWidth/2&&(this.reticlePos.x=h.avatarWidth/2),this.reticlePos.x>i.VIEWABLE_WIDTH-h.avatarWidth/2&&(this.reticlePos.x=i.VIEWABLE_WIDTH-h.avatarWidth/2),this.reticlePos.y<h.avatarWidth/2&&(this.reticlePos.y=h.avatarWidth/2),this.reticlePos.y>i.VIEWABLE_HEIGHT-h.avatarHeight&&(this.reticlePos.y=i.VIEWABLE_HEIGHT-h.avatarHeight)}draw(t,e){t.strokeStyle=this.isShooting?"lime":"red",this.isShooting&&(t.setLineDash([2,4]),t.beginPath(),t.moveTo(Math.round(this.avatarPos.x+h.avatarWidth/2),Math.round(this.avatarPos.y)),t.lineTo(Math.round(this.reticlePos.x),Math.round(this.reticlePos.y)),t.setLineDash([])),t.beginPath(),t.arc(this.reticlePos.x,this.reticlePos.y,Math.round(h.avatarWidth),0,2*Math.PI),t.stroke(),t.drawImage(e.player,50,0,20,32,Math.round(this.avatarPos.x),Math.round(this.avatarPos.y),20,32),this.shots.forEach((e=>e.draw(t)))}}class o{static gridWidth=25;static gridHeight=10;static tileSize=16;static#s=0;static#i=8;static getXForGridIndex(t){return t%o.gridWidth}static getYForGridIndex(t){return Math.floor(t/o.gridWidth)}constructor(t,e,s){const i=document.createElement("canvas");this.tilesCtx=i.getContext("2d"),this.levelData=t,this.waveIndex=0,this.offset=0,this.tiles=Array.of(o.gridWidth*o.gridHeight),this.tiles.fill({})}scroll(t){this.offset=(1-.12)*this.offset+i.PLAYABLE_WIDTH/i.VIEWABLE_WIDTH*t*.12,this.offset<0&&(this.offset=0),this.offset>i.PLAYABLE_WIDTH-i.VIEWABLE_WIDTH&&(this.offset=i.PLAYABLE_WIDTH-i.VIEWABLE_WIDTH)}update(t){if(o.#s+=t,1e3*o.#s>i.TIME_SLOT){o.#s=0;const t=this.levelData[this.waveIndex++];if(void 0!==t){for(let s=0;s<t.length;s++){const i=t[s];e.spawn(i.x,i.y,i.color,i.updater)}console.log("Time for a new wave!",this.waveIndex)}this.waveIndex=this.waveIndex%this.levelData.length}}draw(t,e){t.drawImage(e.levelBG,Math.round(this.offset),0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height)}}class a{constructor(t,e,s,i,h,o,a){this.x=t,this.y=e,this.width=s,this.height=i,this.spriteOffsetX=h,this.spriteOffsetY=o,this.mouseBtnWasHeld=!1,this.flipSprite=a||!1}onClick(t){this.action=t}update(t,e){const s=p(e.mousePos,{x:this.x,y:this.y,width:this.width,height:this.height});s&&!e.mouseButtonHeld&&this.mouseBtnWasHeld&&this.action(),this.mouseBtnWasHeld=s&&e.mouseButtonHeld}draw(t,e){if(this.flipSprite?(t.translate(this.x+this.width,this.y),t.scale(-1,1),t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,0,0,this.width,this.height),t.setTransform(1,0,0,1,0,0)):t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,this.x,this.y,this.width,this.height),this.mouseBtnWasHeld){const e=t.globalAlpha;t.globalAlpha=.3,t.fillStyle="white",t.fillRect(this.x+1,this.y+1,this.width-2,this.height-2),t.globalAlpha=e}}}class n extends a{static WIDTH=17;static HEIGHT=17;constructor(t,e,s,i,h){super(Math.floor(i/2)*n.WIDTH,i%2*n.HEIGHT+h,n.WIDTH,n.HEIGHT,e,s,!1),this.editor=t,this.order=i}action(){console.log("CLICKED",this)}}class r extends n{constructor(t,e,s){super(t,0,0,e,s)}action(){this.editor.toggle()}}class l extends n{constructor(t,e,s){super(t,n.WIDTH,0,e,s)}}class d extends n{constructor(t,e,s){super(t,2*n.WIDTH,0,e,s)}}class c extends n{constructor(t,e,s){super(t,3*n.WIDTH,0,e,s)}}class g extends n{constructor(t,e,s){super(t,0,n.HEIGHT,e,s)}}class u extends n{constructor(t,e,s){super(t,n.WIDTH,n.HEIGHT,e,s)}}class m extends n{constructor(t,e,s){super(t,2*n.WIDTH,n.HEIGHT,e,s)}action(){this.editor.deleteSelected()}}class y extends n{constructor(t,e,s){super(t,3*n.WIDTH,n.HEIGHT,e,s)}}class f{static buttonSpecs=[r,g,l,u,d,m,c,y];constructor(){this.enabled=!0,this.components={timeSlider:new I(this),enemyPalette:new S(this,n.WIDTH*f.buttonSpecs.length/2,184+I.HEIGHT),stageSlider:new x(this)};const t=this.components.timeSlider.y+I.HEIGHT,e=this;this.buttons=f.buttonSpecs.map(((s,i)=>new s(e,i,t))),this.dragObj={},this.isDragging=!1,this.data=Array(Math.ceil(I.MAX_TIME/i.TIME_SLOT)),this.stageOffset=0,this.selectedEnemy=null}scrollRight(t){this.stageOffset+=t,this.stageOffset=Math.min(this.stageOffset,i.PLAYABLE_WIDTH)}scrollLeft(t){this.stageOffset-=t,this.stageOffset=Math.max(this.stageOffset,0)}update(t,e){const s=e.mousePos.x,i=e.mousePos.y;if(!this.isDragging&&e.mouseButtonHeld&&(i<this.components.timeSlider.y||i>this.components.timeSlider.y+I.HEIGHT))if(s>this.components.enemyPalette.x&&s<this.components.enemyPalette.x+this.components.enemyPalette.width&&i>this.components.enemyPalette.y&&i<this.components.enemyPalette.y+this.components.enemyPalette.height){for(const t of this.components.enemyPalette.enemyBoxes)if(s>t.x&&s<t.x+t.width&&i>t.y&&i<t.y+t.height){this.isDragging=!0,this.dragObj={x:t.x,y:t.y,width:t.width,height:t.height,enemy:Object.assign({},t.enemy)};break}}else{const t=this.getEnemiesForTime();for(const[e,h]of t.entries())if(s>h.x&&s<h.x+h.width&&i>h.y&&i<h.y+h.height){this.isDragging=!0,Object.assign(this.dragObj,{x:h.x,y:h.y,width:h.width,height:h.height,enemy:h}),t.splice(e,1);break}}for(const s of Object.values(this.components))s.update(t,e);for(const[s,i]of this.buttons.entries())i.update(t,e);this.isDragging&&(e.mouseButtonHeld?(this.dragObj.x=e.mousePos.x,this.dragObj.y=e.mousePos.y):(this.isDragging=!1,this.dragObj.x>0&&this.dragObj.x+this.dragObj.width<this.components.enemyPalette.containerX&&this.dragObj.y<this.components.timeSlider.y&&(this.dragObj.enemy.x=this.dragObj.x,this.dragObj.enemy.y=this.dragObj.y,this.dragObj.enemy.width=this.dragObj.width,this.dragObj.enemy.height=this.dragObj.height,this.dragObj.enemy.alive=!0,this.dropEnemy())))}getTimeIndex(){return this.components.timeSlider.sliderPos}dropEnemy(){const t=this.getTimeIndex();void 0===this.data[t]&&(this.data[t]=[]),this.data[t].push(this.dragObj.enemy),this.selectedEnemy={enemy:this.dragObj.enemy,index:t,subindex:this.data[t].length-1},console.log("DATA UPDATED",this.data)}getEnemiesForTime(){return this.data[this.getTimeIndex()]||[]}draw(t,e){t.drawImage(e.levelBG,this.stageOffset,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height);for(const s of Object.values(this.components))s.draw(t,e);for(const e of this.getEnemiesForTime())t.fillStyle=e.color,t.fillRect(Math.round(e.x),Math.round(e.y),e.width,e.height);const s=this.getTimeIndex(),h=t.globalAlpha;t.globalAlpha=.3;for(let e=0;e<this.data.length;e++){const h=this.data[e];if(e>=s||void 0===h)continue;const o=(s-e)*i.TIME_SLOT;for(const e of h){t.fillStyle=e.color;const s=e.updater(e,o/1e3);s.alive&&t.fillRect(Math.round(s.x),Math.round(s.y),e.width,e.height)}}if(t.globalAlpha=h,this.isDragging){t.fillStyle=this.dragObj.enemy.color;const e=t.globalAlpha;t.globalAlpha=.5,t.fillRect(Math.round(this.dragObj.x),Math.round(this.dragObj.y),this.dragObj.width,this.dragObj.height),t.globalAlpha=e}for(const[s,i]of this.buttons.entries())i.draw(t,e,this.components.timeSlider.y+I.HEIGHT,s);null!==this.selectedEnemy&&s===this.selectedEnemy.index&&(t.setLineDash([2,3]),t.strokeStyle="lime",t.strokeRect(Math.round(this.selectedEnemy.enemy.x),Math.round(this.selectedEnemy.enemy.y),this.selectedEnemy.enemy.width,this.selectedEnemy.enemy.height),t.setLineDash([]))}toggle(){this.enabled=!this.enabled}deleteSelected(){null!==this.selectedEnemy&&this.getTimeIndex()===this.selectedEnemy.index&&(this.data[this.selectedEnemy.index].splice(this.selectedEnemy.subindex,1),this.selectedEnemy=null)}}function p(t,e){return t.x>e.x&&t.y>e.y&&t.x<e.x+e.width&&t.y<e.y+e.height}class x{static btnSize=11;constructor(t){this.editor=t,this.slidePos=0,this.leftBtn={x:0,y:i.VIEWABLE_HEIGHT-x.btnSize,width:x.btnSize,height:x.btnSize},this.rightBtn={x:i.VIEWABLE_WIDTH-x.btnSize,y:i.VIEWABLE_HEIGHT-x.btnSize,width:x.btnSize,height:x.btnSize},this.mouseHeldOnLeftBtn=!1,this.mouseHeldOnRightBtn=!1}update(t,e){const s=p(e.mousePos,this.leftBtn);s&&!e.mouseButtonHeld&&this.mouseHeldOnLeftBtn&&this.editor.scrollLeft(20),this.mouseHeldOnLeftBtn=s&&e.mouseButtonHeld;const i=p(e.mousePos,this.rightBtn);i&&!e.mouseButtonHeld&&this.mouseHeldOnRightBtn&&this.editor.scrollRight(20),this.mouseHeldOnRightBtn=i&&e.mouseButtonHeld}draw(t,e){const s=t.canvas.height-x.btnSize;t.drawImage(e.editorUI,74,0,x.btnSize,x.btnSize,0,s,x.btnSize,x.btnSize),t.translate(t.canvas.width,s),t.scale(-1,1),t.drawImage(e.editorUI,74,0,x.btnSize,x.btnSize,0,0,x.btnSize,x.btnSize),t.setTransform(1,0,0,1,0,0)}}class I{static SPEED=2;static MAX_TIME=1e5;static HEIGHT=12;static BTN_WIDTH=7;static TIME_STEP=250;constructor(t){this.editor=t,this.sliderPos=0,this.containerY=240-I.HEIGHT,this.y=184,this.isDragging=!1,this.maxPos=(i.VIEWABLE_WIDTH-I.BTN_WIDTH)/2,this.leftBtn=new a(0,this.y,I.BTN_WIDTH,I.HEIGHT,74,20),this.leftBtn.onClick((()=>this.stepLeft())),this.rightBtn=new a(i.VIEWABLE_WIDTH-I.BTN_WIDTH,this.y,I.BTN_WIDTH,I.HEIGHT,74,20,!0),this.rightBtn.onClick((()=>this.stepRight()))}getSelectedTime(){return this.sliderPos*I.TIME_STEP}stepLeft(){this.sliderPos=Math.max(0,this.sliderPos-1),console.log("Changed time slider position",this.sliderPos,"TIME:",this.getSelectedTime())}stepRight(){this.sliderPos=Math.min(this.maxPos,this.sliderPos+1),console.log("Changed time slider position",this.sliderPos,"TIME:",this.getSelectedTime())}screenPosToSliderPos(t){return Math.min(I.MAX_TIME/I.TIME_STEP,Math.max(0,Math.floor((t-I.BTN_WIDTH)/2)))}update(t,e){this.editor.isDragging||(this.leftBtn.update(t,e),this.rightBtn.update(t,e),e.left&&this.stepLeft(),e.right&&this.stepRight(),e.mouseButtonHeld&&e.mousePos.y>=this.y&&e.mousePos.y<=this.y+I.HEIGHT&&e.mousePos.x>I.BTN_WIDTH&&e.mousePos.x<i.VIEWABLE_WIDTH-I.BTN_WIDTH?(this.sliderPos=this.screenPosToSliderPos(e.mousePos.x),this.isDragging=!0):!e.mouseButtonHeld&&this.isDragging&&(this.isDragging=!1,this.sliderPos=this.screenPosToSliderPos(e.mousePos.x),console.log("Changed time slider position",this.sliderPos,"TIME:",this.getSelectedTime())))}draw(t,e){this.leftBtn.draw(t,e);for(let s=7;s<t.canvas.width-I.BTN_WIDTH;s+=2)t.drawImage(e.editorUI,81,20,2,I.HEIGHT,s,this.y,2,I.HEIGHT);this.rightBtn.draw(t,e),t.fillStyle="yellow",t.fillRect(Math.floor(2*this.sliderPos)+I.BTN_WIDTH,this.y+2,1,6)}}function T(t,e){const s=Object.create(t);return s.x+=20*e,s}function E(t,e){const s=Object.create(t);return s.x+=32*e,s}function w(t,e){const s=Object.create(t);return s.x+=10*e,s}function H(t,e){const s=Object.create(t);return s.y+=24*e,s}class S{static margin=4;static boxSize=32;static scrollBtnWidth=6;constructor(t,e,s){this.editor=t,this.x=e,this.y=s,this.containerX=394,this.height=216,this.enemies=[{name:"GHOST",color:"pink",updater:T},{name:"GOBLIN",color:"red",updater:E},{name:"ZOMBIE",color:"orange",updater:w},{name:"SKELETON",color:"magenta",updater:H},{name:"EVILEYE",color:"yellow",updater:T}],this.containerX,this.enemyBoxes=this.enemies.map(((t,e)=>({x:this.x+10+e*S.boxSize,y:this.y+S.margin,width:S.boxSize-2*S.margin,height:S.boxSize-2*S.margin,enemy:t}))),this.width=S.boxSize*this.enemyBoxes.length+2*S.scrollBtnWidth,this.isDragging=!1,this.dragObj={}}update(t,e){}draw(t,e){t.drawImage(e.editorUI,85,0,S.scrollBtnWidth,32,this.x,this.y,S.scrollBtnWidth,32),t.fillStyle="black",t.fillRect(this.x+S.scrollBtnWidth,this.y,S.boxSize*this.enemyBoxes.length,S.boxSize);for(const[s,i]of this.enemyBoxes.entries()){const h=s*S.boxSize;t.fillStyle=i.enemy.color,t.drawImage(e.editorUI,71,0,3,S.boxSize,this.x+S.scrollBtnWidth+h,this.y,3,S.boxSize),t.fillRect(i.x,i.y,i.width,i.height),t.drawImage(e.editorUI,68,0,3,S.boxSize,this.x+S.scrollBtnWidth+(s+1)*S.boxSize-3,this.y,3,S.boxSize)}t.translate(this.x+2*S.scrollBtnWidth+S.boxSize*this.enemyBoxes.length,this.y),t.scale(-1,1),t.drawImage(e.editorUI,85,0,6,32,0,0,6,32),t.setTransform(1,0,0,1,0,0)}}class b{static dt=0;static updateStep=1/60;static last=window.performance&&window.performance.now?window.performance.now():(new Date).getTime();constructor(e){const s=document.getElementById("gameCanvas");this.ctx=s.getContext("2d"),this.assets=e,this.input=new t(s),this.editor=new f,this.input.onRelease(t.EDIT,(t=>this.editor.toggle())),this.player=new h({x:100,y:this.ctx.canvas.height-h.avatarHeight}),this.currentLevel=new o(this.editor.data,this.ctx.canvas.width,this.ctx.canvas.height)}start(){window.requestAnimationFrame(this.getAnimationFrameCallback())}update(t){if(this.editor.enabled)this.editor.update(t,this.input);else{this.currentLevel.update(t,this.input),this.player.update(t,this.input,this.currentLevel);for(const s of e.alive())s.update(t)}}draw(){if(this.ctx.fillStyle=this.editor.enabled?"green":"gray",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.editor.enabled)this.editor.draw(this.ctx,this.assets);else{this.currentLevel.draw(this.ctx,this.assets);for(const t of e.alive())t.draw(this.ctx,this.assets);this.player.draw(this.ctx,this.assets)}}getAnimationFrameCallback(){const t=this;return function(e){for(b.dt+=Math.min(1,(e-b.last)/1e3);b.dt>b.updateStep;)b.dt-=b.updateStep,t.update(b.updateStep);t.draw(),b.last=e,window.requestAnimationFrame(t.getAnimationFrameCallback())}}}const v=[{id:"player",path:"images/julhilde.png"},{id:"tile",path:"images/tile.png"},{id:"levelBG",path:"images/background.gif"},{id:"editorUI",path:"images/editorUI.png"}];window.onload=function(){Promise.all(v.map((t=>async function(t){const e=new Image;return e.src=t.path,await e.decode(),[t.id,e]}(t)))).then((t=>{new b(Object.fromEntries(t)).start()}))}})();