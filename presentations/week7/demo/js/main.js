(()=>{"use strict";const t={TIME_SLOT:250,VIEWABLE_WIDTH:426,VIEWABLE_HEIGHT:240,PLAYABLE_WIDTH:800,DODGE_ENABLED:!0,DODGE_DOUBLE_TAP_TIMING:250,DODGE_TIMESPAN:250,DODGE_SPEED_BOOST:4};Object.freeze(t);class e{static EDIT="e";constructor(t){this.up=this.down=this.left=this.right=this.shoot=!1,this.rightReleaseTime=this.leftReleaseTime=this.dodgeLeftUntil=this.dodgeRightUntil=0,this.edit=!1,this.onReleaseHooks={},this.mousePos={x:null,y:null},this.mouseButtonHeld=!1;const e=this;document.addEventListener("keydown",(t=>e.keyPress(t))),document.addEventListener("keyup",(t=>e.keyRelease(t))),t.addEventListener("mousemove",(t=>e.updateMousePos(t))),t.addEventListener("mousedown",(t=>{e.mouseButtonHeld=!0})),t.addEventListener("mouseup",(t=>{e.mouseButtonHeld=!1}))}flipInputState(e,s){switch(e){case" ":this.shoot=s;break;case"ArrowLeft":if(this.left=s,t.DODGE_ENABLED){let e=performance.now();s?performance.now()<this.leftReleaseTime+t.DODGE_DOUBLE_TAP_TIMING&&(this.dodgeLeftUntil=e+t.DODGE_TIMESPAN):(this.leftReleaseTime=e,this.dodgeLeftUntil=0)}break;case"ArrowRight":if(this.right=s,t.DODGE_ENABLED){let e=performance.now();s?performance.now()<this.rightReleaseTime+t.DODGE_DOUBLE_TAP_TIMING&&(this.dodgeRightUntil=e+t.DODGE_TIMESPAN):(this.rightReleaseTime=e,this.dodgeRightUntil=0)}break;case"ArrowUp":this.up=s;break;case"ArrowDown":this.down=s;break;case"e":this.edit=s}}keyPress(t){t.defaultPrevented||t.repeat||"F12"!=t.key&&(t.preventDefault(),this.flipInputState(t.key,!0))}keyRelease(t){if(!t.defaultPrevented&&"F12"!=t.key){t.preventDefault(),this.flipInputState(t.key,!1);for(const e of this.onReleaseHooks[t.key]||[])e(t)}}onRelease(t,e){void 0===this.onReleaseHooks[t]?this.onReleaseHooks[t]=[e]:this.onReleaseHooks[t].push(e)}updateMousePos(t){const e=t.target.getBoundingClientRect(),s=t.target.width/e.width,i=t.target.height/e.height,h=document.documentElement;this.mousePos.x=s*(t.clientX-e.left-h.scrollLeft),this.mousePos.y=i*(t.clientY-e.top-h.scrollTop)}}class s{static alive=function*(){for(const t of this.INSTANCES)t.live&&(yield t)};static spawn(...t){let e=this.INSTANCES.filter((t=>!t.live)).pop();return void 0===e?(e=new this(...t),this.INSTANCES.push(e),console.log("Created new entity",e)):(e.init(...t),console.log("Recycled entity",e)),e}constructor(t,e,s,i,h,...a){this.init(t,e,s,i,h,...a)}init(t,e,s,i,h,...a){this.live=!0,this.x=t,this.y=e,this.width=s,this.height=i,this.imageSpec=h}draw(t,e,s){t.drawImage(e[this.imageSpec.id],this.imageSpec.sx,this.imageSpec.sy,this.imageSpec.sWidth,this.imageSpec.sHeight,Math.round(this.x-s),Math.round(this.y),this.width,this.height)}}class i extends s{static INSTANCES=[];init(t,e,s,i,h,a,o,n,r){return super.init(t,e,s,i,h,a,o,n,r),this.radius=s,this.target=a,this.velocity={x:o*(this.target.x-this.x),y:o*(this.target.y-this.y)},this.hooks=r,this.reachedTarget=!1,this}update(t){this.x+=this.velocity.x*t,this.y+=this.velocity.y*t,this.reachedTarget=this.velocity.y>0?this.y>this.target.y+this.target.height:this.y<this.target.y,this.reachedTarget&&(this.live=!1,this.hooks.forEach((e=>e(t,this))))}draw(t,e,s){const i=this.reachedTarget?this.target.x:this.x,h=this.reachedTarget?this.target.y:this.y;t.drawImage(e[this.imageSpec.id],this.imageSpec.sx,this.imageSpec.sy,this.imageSpec.sWidth,this.imageSpec.sHeight,Math.round(i-s-this.imageSpec.sWidth/2),Math.round(h-1.5*this.imageSpec.sHeight),this.imageSpec.sWidth,this.imageSpec.sHeight)}}class h extends s{static INSTANCES=[];init(t,e,s,i,h,a,o,n){super.init(t,e,s,i,h,o,n),this.startX=t,this.endX=a,this.speed=64,this.velX=Math.sign(this.endX-this.startX)*this.speed,this.endXTime=(this.endX-this.startX)/this.velX,o=void 0===o?1:o||1,this.endAttackTime=this.endXTime+o,this.timeToReturn=void 0===n?1:n||1,this.attacked=!1,this.hitTargetHooks=[]}update(e,s){if(this.live)if(e<this.endXTime)this.x=this.startX+this.velX*e;else if(e<this.endAttackTime)console.log("WAITING TO ATTACK",this),this.x=this.endX;else if(this.attacked)e>this.endAttackTime+this.timeToReturn?(this.x=this.endX-this.velX*(e-this.endAttackTime-this.timeToReturn),(this.x+this.width<0||this.x>t.PLAYABLE_WIDTH)&&(this.live=!1)):this.x=this.endX;else{this.x=this.endX;const t=i.spawn(this.x+this.width/2,this.y+this.height/2,1.5,1.5,{id:"bullets",sx:12,sy:2,sWidth:6,sHeight:6},{x:s.avatarPos.x+1.5*a.avatarWidth,y:s.avatarPos.y,height:a.avatarHeight/2},6,1,this.hitTargetHooks);console.log("SHOT",t),this.attacked=!0}}}class a{static avatarHeight=32;static avatarWidth=8;static reticleSpeed=270;static avatarSpeed=120;static timeBetweenShots=1/9;static getAxis=function(t,e,s,i){let h={x:0,y:0};return t?h.y+=-1:e&&(h.y+=1),s?h.x+=-1:i&&(h.x+=1),h};static clampNorm=function(t,e){const s=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),i=Math.min(s,e)/s;return{x:i*t.x,y:i*t.y}};static onHitTarget=function(t,e){for(const t of h.alive())Math.sqrt(Math.pow(t.x+t.width/2-e.target.x,2)+Math.pow(t.y+t.height/2-e.target.y,2))<=16&&(t.live=!1)};constructor(t){this.avatarPos={x:100,y:t.y},this.reticlePos={x:t.x+4,y:t.y-100},this.shots=[],this.shotDelay=0,this.hitTargetHooks=[a.onHitTarget],this.isShooting=!1,this.shootingSound="playerShooting1"}update(e,s,h,o){if(this.shots=this.shots.filter((t=>t.live)),s.shoot){if(this.shotDelay<=0){this.isShooting=!0,this.shots.push(i.spawn(this.avatarPos.x+a.avatarWidth/2,this.avatarPos.y,a.avatarWidth/2,a.avatarWidth/2,{id:"bullets",sx:1,sy:1,sWidth:8,sHeight:8},{x:this.reticlePos.x,y:this.reticlePos.y,height:3},8,10,this.hitTargetHooks)),this.shotDelay=a.timeBetweenShots;const t=o.audioCtx.createBufferSource();t.buffer=o.assets.sounds[this.shootingSound],this.shootingSound="playerShooting1"==this.shootingSound?"playerShooting2":"playerShooting1",t.connect(o.audioCtx.destination),t.start()}}else{if(s.left){let i=s.dodgeLeftUntil>performance.now()?t.DODGE_SPEED_BOOST:1;this.avatarPos.x=Math.max(0,this.avatarPos.x-a.avatarSpeed*e*i)}if(s.right){let i=s.dodgeRightUntil>performance.now()?t.DODGE_SPEED_BOOST:1;this.avatarPos.x=Math.min(h.width-a.avatarWidth,this.avatarPos.x+a.avatarSpeed*e*i)}this.isShooting=!1}this.shotDelay-=e;const n=a.getAxis(s.up,s.down,s.left,s.right);if(0!==n.x||0!==n.y){const t=a.clampNorm({x:n.x*a.reticleSpeed,y:n.y*a.reticleSpeed},a.reticleSpeed);this.reticlePos.x+=t.x*e,this.reticlePos.y+=t.y*e,s.dodgeRight}const r=this.avatarPos.x-h.offset;r>t.VIEWABLE_WIDTH*(2/3)&&h.scrollRight(e),r<t.VIEWABLE_WIDTH/3&&h.scrollLeft(e),this.reticlePos.x<h.offset+a.avatarWidth/2&&(this.reticlePos.x=h.offset+a.avatarWidth/2),this.reticlePos.x>h.offset+t.VIEWABLE_WIDTH-a.avatarWidth/2&&(this.reticlePos.x=h.offset+t.VIEWABLE_WIDTH-a.avatarWidth/2),this.reticlePos.y<a.avatarWidth/2&&(this.reticlePos.y=a.avatarWidth/2),this.reticlePos.y>t.VIEWABLE_HEIGHT-a.avatarHeight&&(this.reticlePos.y=t.VIEWABLE_HEIGHT-a.avatarHeight)}draw(t,e,s){t.strokeStyle=this.isShooting?"lime":"red",t.beginPath(),t.arc(Math.round(this.reticlePos.x-s),Math.round(this.reticlePos.y),Math.round(a.avatarWidth),0,2*Math.PI),t.stroke(),t.drawImage(e.player,50,0,20,32,Math.round(this.avatarPos.x-s),Math.round(this.avatarPos.y),20,32)}}class o extends s{static INSTANCES=[]}class n{static#t=0;static#e=0;static#s=256;constructor(t,e,s,i){this.levelData=t,this.width=e,this.offset=0,this.enemies=[],this.props=t.props.map((t=>o.spawn(t.x,t.y,t.width,t.height,t.imageSpec))),this.player=i,this.entitiesToDraw=[]}reset(t){n.#t=0,n.#e=0,this.levelData=t,this.offset=0,this.enemies=[];for(const t of h.alive())t.live=!1;for(const t of this.props)t.live=!0}scrollLeft(t){this.offset=Math.max(0,this.offset-n.#s*t)}scrollRight(e){this.offset=Math.min(this.offset+n.#s*e,this.width-t.VIEWABLE_WIDTH)}update(e){n.#t+=e,n.#e+=e;const s=Math.floor(1e3*n.#t/t.TIME_SLOT);if(1e3*n.#e>t.TIME_SLOT){void 0===this.enemies[s-1]&&(this.enemies[s-1]=[]);for(const t of Object.keys(this.levelData.walkways).sort())for(const e of this.levelData.walkways[t][s-1]||[]){const i=e.count||1;for(let a=0;a<i;a++){const o=e.endX+a*e.width,n=h.spawn(e.x+a*e.width,Number(t)-e.height,e.width,e.height,e.imageSpec,o,e.timeToAttack,e.timeToReturn);a<i&&new h(e.x+(a+1)*e.width,Number(t)-e.height,e.width,e.height,e.imageSpec,o+(a+1)*e.width,e.timeToAttack,e.timeToReturn),this.enemies[s-1].push(n)}}n.#e=0}for(let e=0;e<=s;e++)if(void 0!==this.enemies[e])for(const s of this.enemies[e])s.live&&s.update(n.#t-e*t.TIME_SLOT/1e3,this.player);for(const t of i.alive())t.update(e);this.entitiesToDraw=Array.from(h.alive()).concat(Array.from(o.alive())).sort(((t,e)=>t.y-e.y)).concat(Array.from(i.alive()))}draw(t,e){t.drawImage(e.levelBG,Math.round(this.offset),0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height);for(const s of this.entitiesToDraw)s.draw(t,e,this.offset)}}class r{constructor(t,e,s,i,h,a,o){this.x=t,this.y=e,this.width=s,this.height=i,this.spriteOffsetX=h,this.spriteOffsetY=a,this.mouseBtnWasHeld=!1,this.flipSprite=o||!1}onClick(t){this.action=t}update(t,e){const s=f(e.mousePos,{x:this.x,y:this.y,width:this.width,height:this.height});s&&!e.mouseButtonHeld&&this.mouseBtnWasHeld&&this.action(),this.mouseBtnWasHeld=s&&e.mouseButtonHeld}draw(t,e){if(this.flipSprite?(t.translate(this.x+this.width,this.y),t.scale(-1,1),t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,0,0,this.width,this.height),t.setTransform(1,0,0,1,0,0)):t.drawImage(e.editorUI,this.spriteOffsetX,this.spriteOffsetY,this.width,this.height,this.x,this.y,this.width,this.height),this.mouseBtnWasHeld){const e=t.globalAlpha;t.globalAlpha=.3,t.fillStyle="white",t.fillRect(this.x+1,this.y+1,this.width-2,this.height-2),t.globalAlpha=e}}}class l extends r{static WIDTH=17;static HEIGHT=16;constructor(t,e,s,i,h){super(Math.floor(i/2)*l.WIDTH,i%2*l.HEIGHT+h,l.WIDTH,l.HEIGHT,e,s,!1),this.editor=t,this.order=i}action(){console.log("CLICKED",this)}}class d extends l{constructor(t,e,s){super(t,0,0,e,s)}action(){this.editor.toggle()}}class g extends l{constructor(t,e,s){super(t,2*l.WIDTH,0,e,s)}action(){this.editor.chainSelected()}}class c extends l{constructor(t,e,s){super(t,3*l.WIDTH,0,e,s)}action(){this.editor.undo()}}class y extends l{constructor(t,e,s){super(t,l.WIDTH,l.HEIGHT-1,e,s)}action(){this.editor.addWalkWay()}}class p extends l{constructor(t,e,s){super(t,2*l.WIDTH,l.HEIGHT,e,s)}action(){this.editor.deleteSelected()}}class m extends l{constructor(t,e,s){super(t,3*l.WIDTH,l.HEIGHT,e,s)}action(){this.editor.save().then((()=>alert("Level saved correctly")))}}class u{static buttonSpecs=[d,p,g,y,c,m];static WP_HANDLE_SIZE=8;static WING_WIDTH=64;static WALKWAY_COVER_DISTANCE=8;static#i=["graveyard"];constructor(t){this.enabled=!0,this.onToggleHook=()=>{},this.components={timeSlider:new W(this),enemyPalette:new x(this,l.WIDTH*u.buttonSpecs.length/2,184+W.HEIGHT),propPalette:new S(this,4*(x.boxSize+x.margin)+l.WIDTH*u.buttonSpecs.length/2,184+W.HEIGHT),stageSlider:new w(this)};const e=this.components.timeSlider.y+W.HEIGHT,s=this;this.buttons=u.buttonSpecs.map(((t,i)=>new t(s,i,e))),this.dragObj={},this.dragWP={},this.dragWW=null,this.newWalkWay=null,this.enemyWalkWay=null,this.isAddingWalkWay=!1,this.selectedWalkWay=null,this.isDragging=!1,this.isDraggingWP=!1,this.isDraggingWW=!1,this.stageOffset=0,this.dragOffset={x:0,y:0},this.selectedEnemy=null,this.selectedProp=null,this.simEnemies=[],this.undoList=[],this.levelData=t||{props:[],walkways:{150:[]}}}scrollRight(e){this.stageOffset+=e,this.stageOffset=Math.min(this.stageOffset,t.PLAYABLE_WIDTH-t.VIEWABLE_WIDTH+u.WING_WIDTH)}scrollLeft(t){this.stageOffset-=t,this.stageOffset=Math.max(this.stageOffset,-u.WING_WIDTH)}update(e,s){const i=s.mousePos.x,h=s.mousePos.y;if(this.getTimeIndex(),this.isAddingWalkWay)this.newWalkWay=h,s.mouseButtonHeld&&(this.isAddingWalkWay=!1,void 0===this.levelData.walkways&&(this.levelData.walkways=[]),this.newWalkWay<this.components.timeSlider.y?this.levelData.walkways[Math.round(this.newWalkWay)]=[]:console.log("Dropped walkway outside of gameplay area"),this.newWalkWay=null);else if(!this.isDragging&&!this.isDraggingWP&&s.mouseButtonHeld&&(h<this.components.timeSlider.y||h>this.components.timeSlider.y+W.HEIGHT)){const t=f(s.mousePos,this.components.enemyPalette)||f(s.mousePos,this.components.propPalette);if(t){const t=this.components.enemyPalette.boxes.concat(this.components.propPalette.boxes);for(const e of t)if(f(s.mousePos,e)){this.isDragging=!0,this.dragObj={x:e.x,y:e.y,width:e.entity.width,height:e.entity.height,entity:Object.assign({},e.entity),new:!0},this.dragOffset.x=this.dragObj.x-i,this.dragOffset.y=this.dragObj.y-h;break}}else{for(const[t,e,s]of this.getEnemiesForTime()){const a={x:s.endX?s.endX:s.x+s.width/2-u.WP_HANDLE_SIZE/2,y:s.y+s.height/2-u.WP_HANDLE_SIZE/2,width:u.WP_HANDLE_SIZE,height:u.WP_HANDLE_SIZE};if(f({x:i+this.stageOffset,y:h},a)){this.isDraggingWP=!0,Object.assign(this.dragWP,{walkway:e,index:this.getTimeIndex(),subindex:t,start:{x:s.x+s.width/2-this.stageOffset,y:s.y+s.height/2},end:{x:i-this.stageOffset,y:s.y+s.height/2}});break}if(f({x:i+this.stageOffset,y:h},{x:s.x,y:s.y,width:s.width*(s.count||1),height:s.height})){this.isDragging=!0,Object.assign(this.dragObj,{x:s.x,y:s.y,width:s.width,height:s.height,entity:s,endX:s.x+this.stageOffset+s.width,subindex:t,oldWW:e}),this.dragObj.new=!1,this.dragOffset.x=this.dragObj.x-i-this.stageOffset,this.dragOffset.y=this.dragObj.y-h;break}}if(!this.isDragging)for(const[t,e]of this.levelData.props.entries())if(f({x:i+this.stageOffset,y:h},e)){this.isDragging=!0,Object.assign(this.dragObj,{x:e.x,y:e.y,width:e.width,height:e.height,entity:e,index:t,new:!1}),this.dragOffset.x=this.dragObj.x-i-this.stageOffset,this.dragOffset.y=this.dragObj.y-h;break}}if(!(t||this.isDragging||this.isDraggingWP||this.isDraggingWW))for(const t of Object.keys(this.levelData.walkways))if(h>t-10&&h<t){this.isDraggingWW=!0,this.dragWW={y:t,old:t},this.dragOffset.y=t-h;break}}for(const t of Object.values(this.components))t.update(e,s);for(const[t,i]of this.buttons.entries())i.update(e,s);if(this.isDraggingWP)s.mouseButtonHeld?this.dragWP.end.x=s.mousePos.x:(this.isDraggingWP=!1,this.dragWP.end.x>0&&this.dragWP.end.x<t.VIEWABLE_WIDTH&&this.dropWP());else if(this.isDragging)if(s.mouseButtonHeld){this.dragObj.x=s.mousePos.x+this.dragOffset.x+this.stageOffset,this.dragObj.y=s.mousePos.y+this.dragOffset.y;let t=Number.MAX_SAFE_INTEGER;for(const e of Object.keys(this.levelData.walkways))Math.abs(e-h)<=Math.abs(t-h)&&(t=e);this.enemyWalkWay=t}else this.isDragging=!1,this.dragObj.x>-u.WING_WIDTH&&this.dragObj.x+this.dragObj.width<t.PLAYABLE_WIDTH+u.WING_WIDTH&&this.dropEntity();else if(this.isDraggingWW)if(s.mouseButtonHeld)this.dragWW.y=s.mousePos.y+this.dragOffset.y;else{if(this.dragWW.y<this.components.timeSlider.y){if(this.dragWW.old!==this.dragWW.y.toString()){this.undoList.push(this.takeDataSnapshot()),this.levelData.walkways[this.dragWW.y.toString()]=this.levelData.walkways[this.dragWW.old].map((t=>(t||[]).map((t=>(t.y=this.dragWW.y-t.height,t))))),delete this.levelData.walkways[this.dragWW.old];for(const t of this.levelData.props.filter((t=>t.y==this.dragWW.old-t.height+u.WALKWAY_COVER_DISTANCE)))t.y=this.dragWW.y-t.height+u.WALKWAY_COVER_DISTANCE;this.updateSimEnemies(this.getTimeIndex())}this.selectedWalkWay=this.dragWW.y.toString(),this.selectedEnemy=null,this.selectedProp=null}else console.log("Dropped walkway outside of gameplay area");this.isDraggingWW=!1,this.dragWW=null}}updateSimEnemies(e){this.simEnemies=[];for(const[s,i]of Object.entries(this.levelData.walkways))for(let a=0;a<e;a++){const o=i[a];if(void 0===o)continue;const n=(e-a)*t.TIME_SLOT;for(const t of o||[]){const e=t.count||1;for(let i=0;i<e;i++){const e=h.spawn(t.x+t.width*i,Number(s)-t.height,t.width,t.height,t.imageSpec,t.endX+t.width*i);e.attacked=!0,e.update(n/1e3),this.simEnemies.push(e)}}}}getTimeIndex(){return this.components.timeSlider.sliderPos}addEnemy(t,e,s){return null==s&&(s=this.getTimeTimeIdx()),void 0!==this.levelData.walkways[t][s]&&null!==this.levelData.walkways[t][s]||(this.levelData.walkways[t][s]=[]),this.levelData.walkways[t][s].push(e)-1}addProp(t){return this.levelData.props.push(t)-1}deleteProp(t){this.levelData.props.splice(t,1)}dropEntity(){this.undoList.push(this.takeDataSnapshot());const t=this.dragObj.entity;switch(t.x=this.dragObj.x,t.type){case"enemy":{t.y=Number(this.enemyWalkWay)-t.height;const e=this.getTimeIndex();this.selectedEnemy={enemy:t,index:e,walkway:this.enemyWalkWay},this.selectedWalkWay=null,this.dragObj.new||this.deleteEnemy(this.dragObj.oldWW,e,this.dragObj.subindex),this.selectedEnemy.subindex=this.addEnemy(this.enemyWalkWay,t,e),this.enemyWalkWay=null,this.selectedProp=null;break}case"prop":{Math.abs(this.dragObj.y-Number(this.enemyWalkWay))<1.5*t.height?t.y=Number(this.enemyWalkWay)-t.height+u.WALKWAY_COVER_DISTANCE:t.y=this.dragObj.y,this.dragObj.new||this.deleteProp(this.dragObj.index);const e=this.addProp(t);this.selectedEnemy=null,this.enemyWalkWay=null,this.selectedProp={prop:t,index:e};break}default:console.error("Unknown entity type",t)}}dropWP(){this.undoList.push(this.takeDataSnapshot());const t=this.levelData.walkways[this.dragWP.walkway][this.dragWP.index][this.dragWP.subindex];t.endX=this.dragWP.end.x+this.stageOffset,this.selectedEnemy={enemy:t,walkway:this.dragWP.walkway,index:this.dragWP.index,subindex:this.dragWP.subindex},this.selectedWalkWay=null,this.selectedProp=null}takeDataSnapshot(){const t={props:(this.levelData.props||[]).map((t=>({...t}))),walkways:JSON.parse(JSON.stringify(this.levelData.walkways))};return console.log("Took data snapshot",t),t}*getEnemiesForTime(){const t=this.getTimeIndex();for(const e of Object.keys(this.levelData.walkways).sort()){const s=this.levelData.walkways[e][t]||[];for(const[t,i]of s.entries())yield[t,e,i]}}drawEntity(t,e,s,i){i=i||0;const h=t.imageSpec;e.drawImage(s[h.id],h.sx,h.sy,h.sWidth,h.sHeight,Math.round(t.x-this.stageOffset+i*t.width),Math.round(t.y),t.width,t.height)}draw(t,e){const s=t.globalAlpha;t.drawImage(e.levelBG,this.stageOffset,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height);for(const e of Object.keys(this.levelData.walkways)){t.globalAlpha=.6,e===this.enemyWalkWay?t.fillStyle="fuchsia":e===this.selectedWalkWay?(t.globalAlpha=.8,t.fillStyle="lime"):t.fillStyle="indianred",t.fillRect(0,Math.round(e)-10,t.canvas.width,10),t.fillStyle="white",t.globalAlpha=.9;const i=this.levelData.walkways[e].flat().filter((t=>null!==t)).reduce(((t,e)=>t+(e.count||1)),0);t.fillText(i.toString(),2,Math.round(e)-1),t.globalAlpha=s}this.isAddingWalkWay&&null!==this.newWalkWay&&(t.fillStyle="hotpink",t.fillRect(0,Math.round(this.newWalkWay)-10,t.canvas.width,10));for(const s of Object.values(this.components))s.draw(t,e);for(const[s,i,h]of this.getEnemiesForTime()){const s=h.count||1;for(let i=0;i<s;i++)this.drawEntity(h,t,e,i);const i=h.y+h.height/2;h.endX?(t.strokeStyle="yellow",t.beginPath(),t.moveTo(Math.round(h.x-this.stageOffset+h.width*(h.count||1)/2),Math.round(h.y+h.height/2)),t.lineTo(Math.round(h.endX-this.stageOffset),Math.round(i)),t.stroke(),t.strokeStyle="cyan",t.strokeRect(Math.round(h.endX-this.stageOffset-u.WP_HANDLE_SIZE/2),Math.round(i-u.WP_HANDLE_SIZE/2),u.WP_HANDLE_SIZE,u.WP_HANDLE_SIZE)):t.strokeRect(Math.round(h.x-this.stageOffset+h.width/2-u.WP_HANDLE_SIZE/2),Math.round(i-u.WP_HANDLE_SIZE/2),u.WP_HANDLE_SIZE,u.WP_HANDLE_SIZE)}const i=this.getTimeIndex();t.globalAlpha=.3;for(const s of this.simEnemies)this.drawEntity(s,t,e);t.globalAlpha=s;for(const s of Object.keys(this.levelData.walkways).map(Number).sort(((t,e)=>t-e)).map((t=>t.toString())))for(const i of this.levelData.props.filter((t=>t.y<Number(s))))this.drawEntity(i,t,e);if(this.isDraggingWP&&(t.strokeStyle="red",t.beginPath(),t.moveTo(this.dragWP.start.x,this.dragWP.start.y),t.lineTo(this.dragWP.end.x,this.dragWP.end.y),t.stroke()),this.isDragging){t.fillStyle=this.dragObj.entity.color;const s=t.globalAlpha;t.globalAlpha=.5,this.drawEntity(this.dragObj.entity,t,e),t.globalAlpha=s}for(const[s,i]of this.buttons.entries())i.draw(t,e,this.components.timeSlider.y+W.HEIGHT,s);null!==this.selectedEnemy&&i===this.selectedEnemy.index&&(t.setLineDash([2,3]),t.strokeStyle="lime",t.strokeRect(Math.round(this.selectedEnemy.enemy.x-this.stageOffset),Math.round(this.selectedEnemy.enemy.y),this.selectedEnemy.enemy.width*(this.selectedEnemy.enemy.count||1),this.selectedEnemy.enemy.height),t.setLineDash([])),null!==this.selectedProp&&(t.setLineDash([2,3]),t.strokeStyle="lime",t.strokeRect(Math.round(this.selectedProp.prop.x-this.stageOffset),Math.round(this.selectedProp.prop.y),this.selectedProp.prop.width,this.selectedProp.prop.height),t.setLineDash([])),this.isDragging&&(t.setLineDash([2,3]),t.strokeStyle="pink",t.strokeRect(Math.round(this.dragObj.x-this.stageOffset),Math.round(this.dragObj.y),this.dragObj.width*(this.dragObj.entity.count||1),this.dragObj.height),t.setLineDash([])),this.isDraggingWW&&(t.globalAlpha=.8,t.fillStyle="lime",t.fillRect(0,Math.round(this.dragWW.y)-10,t.canvas.width,10),t.globalAlpha=s)}toggle(){this.enabled=!this.enabled,this.enabled?this.updateSimEnemies(this.components.timeSlider.sliderPos):this.onToggleHook(this.takeDataSnapshot())}onToggle(t){this.onToggleHook=t}deleteEnemy(t,e,s){Array.isArray(this.levelData.walkways[t][e])&&this.levelData.walkways[t][e].splice(s,1)}deleteSelected(){null!==this.selectedEnemy&&this.getTimeIndex()===this.selectedEnemy.index?(this.undoList.push(this.takeDataSnapshot()),this.deleteEnemy(this.selectedEnemy.walkway,this.selectedEnemy.index,this.selectedEnemy.subindex),this.selectedEnemy=null,console.log("DATA UPDATED",this.levelData,this.undoList)):null!==this.selectedProp?(this.undoList.push(this.takeDataSnapshot()),this.deleteProp(this.selectedProp.index),this.selectedProp=null):null!==this.selectedWalkWay&&(this.undoList.push(this.takeDataSnapshot()),delete this.levelData.walkways[this.selectedWalkWay],this.selectedWalkWay=null)}undo(){if(this.undoList.length){const t=this.undoList.pop();this.levelData=t,this.selectedEnemy=null,this.selectedWalkWay=null}else console.log("No further undo information")}chainSelected(){if(null!==this.selectedEnemy&&this.getTimeIndex()===this.selectedEnemy.index){const t=this.selectedEnemy.walkway,e=this.selectedEnemy.index,s=this.selectedEnemy.subindex;this.undoList.push(this.takeDataSnapshot());const i=this.levelData.walkways[t][e][s];i.count=(i.count||1)+1}}async save(){const t=await window.showSaveFilePicker(),e=await t.createWritable(),s=JSON.stringify(this.takeDataSnapshot(),null,2),i=new Blob([s],{type:"application/json"});return await e.write(i),await e.close(),s}addWalkWay(){this.isAddingWalkWay||(this.isAddingWalkWay=!0,this.newWalkWay=null)}}function f(t,e){return t.x>e.x&&t.y>e.y&&t.x<e.x+e.width&&t.y<e.y+e.height}class w{static btnSize=11;constructor(e){this.editor=e,this.slidePos=0,this.leftBtn={x:0,y:t.VIEWABLE_HEIGHT-w.btnSize,width:w.btnSize,height:w.btnSize},this.rightBtn={x:t.VIEWABLE_WIDTH-w.btnSize,y:t.VIEWABLE_HEIGHT-w.btnSize,width:w.btnSize,height:w.btnSize},this.mouseHeldOnLeftBtn=!1,this.mouseHeldOnRightBtn=!1}update(t,e){const s=f(e.mousePos,this.leftBtn);s&&!e.mouseButtonHeld&&this.mouseHeldOnLeftBtn&&this.editor.scrollLeft(20),this.mouseHeldOnLeftBtn=s&&e.mouseButtonHeld;const i=f(e.mousePos,this.rightBtn);i&&!e.mouseButtonHeld&&this.mouseHeldOnRightBtn&&this.editor.scrollRight(20),this.mouseHeldOnRightBtn=i&&e.mouseButtonHeld}draw(t,e){const s=t.canvas.height-w.btnSize;t.drawImage(e.editorUI,74,0,w.btnSize,w.btnSize,0,s,w.btnSize,w.btnSize),t.translate(t.canvas.width,s),t.scale(-1,1),t.drawImage(e.editorUI,74,0,w.btnSize,w.btnSize,0,0,w.btnSize,w.btnSize),t.setTransform(1,0,0,1,0,0)}}class W{static SPEED=2;static MAX_TIME=1e5;static HEIGHT=12;static BTN_WIDTH=7;static TIME_STEP=250;constructor(e){this.editor=e,this.sliderPos=0,this.containerY=240-W.HEIGHT,this.y=184,this.isDragging=!1,this.maxPos=(t.VIEWABLE_WIDTH-W.BTN_WIDTH)/2,this.leftBtn=new r(0,this.y,W.BTN_WIDTH,W.HEIGHT,74,20),this.leftBtn.onClick((()=>this.stepLeft())),this.rightBtn=new r(t.VIEWABLE_WIDTH-W.BTN_WIDTH,this.y,W.BTN_WIDTH,W.HEIGHT,74,20,!0),this.rightBtn.onClick((()=>this.stepRight()))}getSelectedTime(){return this.sliderPos*W.TIME_STEP}updateSliderPos(t){this.sliderPos=t,console.log("Changed time slider position",this.sliderPos,"TIME:",this.getSelectedTime()),this.editor.updateSimEnemies(this.sliderPos)}stepLeft(){this.updateSliderPos(Math.max(0,this.sliderPos-1))}stepRight(){this.updateSliderPos(Math.min(this.maxPos,this.sliderPos+1))}screenPosToSliderPos(t){return Math.min(W.MAX_TIME/W.TIME_STEP,Math.max(0,Math.floor((t-W.BTN_WIDTH)/2)))}update(e,s){this.editor.isDragging||(this.leftBtn.update(e,s),this.rightBtn.update(e,s),s.left&&this.stepLeft(),s.right&&this.stepRight(),s.mouseButtonHeld&&s.mousePos.y>=this.y&&s.mousePos.y<=this.y+W.HEIGHT&&s.mousePos.x>W.BTN_WIDTH&&s.mousePos.x<t.VIEWABLE_WIDTH-W.BTN_WIDTH?(this.updateSliderPos(this.screenPosToSliderPos(s.mousePos.x)),this.isDragging=!0):!s.mouseButtonHeld&&this.isDragging&&(this.isDragging=!1,this.updateSliderPos(this.screenPosToSliderPos(s.mousePos.x))))}draw(t,e){this.leftBtn.draw(t,e);for(let s=W.BTN_WIDTH;s<t.canvas.width-W.BTN_WIDTH;s+=2)t.drawImage(e.editorUI,81,20,2,W.HEIGHT,s,this.y,2,W.HEIGHT);this.rightBtn.draw(t,e),t.fillStyle="red";for(const e of Object.values(this.editor.levelData.walkways))for(const[s,i]of e.entries())(i||[]).length&&t.fillRect(Math.floor(2*s)+W.BTN_WIDTH,this.y+2,1,6);t.fillStyle="yellow",t.fillRect(Math.floor(2*this.sliderPos)+W.BTN_WIDTH,this.y+2,1,6)}}class x{static margin=4;static boxSize=32;static scrollBtnWidth=6;constructor(t,e,s){this.editor=t,this.x=e,this.y=s,this.containerX=394,this.height=216,this.enemies=[{type:"enemy",name:"RASPBERRY_DONUT",width:32,height:32,imageSpec:{id:"donutSheet",sx:0,sy:0,sWidth:32,sHeight:32}},{type:"enemy",name:"CHOCO_DONUT",width:32,height:32,imageSpec:{id:"donutSheet",sx:0,sy:32,sWidth:32,sHeight:32}},{type:"enemy",name:"FROSTED_DONUT",width:32,height:32,imageSpec:{id:"donutSheet",sx:0,sy:64,sWidth:32,sHeight:32}},{type:"enemy",name:"ESPRESSO",width:45,height:32,imageSpec:{id:"expressoGangsterSheet",sx:0,sy:0,sWidth:45,sHeight:32}},{type:"enemy",name:"EVIL_PRINTER",width:32,height:32,imageSpec:{id:"printerSheet",sx:0,sy:0,sWidth:32,sHeight:32}}],this.containerX,this.boxes=this.enemies.map(((t,e)=>({x:this.x+10+e*x.boxSize,y:this.y+x.margin,width:x.boxSize-2*x.margin,height:x.boxSize-2*x.margin,entity:t}))),this.width=x.boxSize*this.boxes.length+2*x.scrollBtnWidth,this.isDragging=!1,this.dragObj={}}update(t,e){}draw(t,e){t.drawImage(e.editorUI,85,0,x.scrollBtnWidth,32,this.x,this.y,x.scrollBtnWidth,32),t.fillStyle="black",t.fillRect(this.x+x.scrollBtnWidth,this.y,x.boxSize*this.boxes.length,x.boxSize);for(const[s,i]of this.boxes.entries()){const h=s*x.boxSize;t.drawImage(e.editorUI,71,0,3,x.boxSize,this.x+x.scrollBtnWidth+h,this.y,3,x.boxSize);const a=i.entity.imageSpec;t.drawImage(e[a.id],a.sx,a.sy,a.sWidth,a.sHeight,Math.round(i.x),Math.round(i.y),i.width,i.height),t.drawImage(e.editorUI,68,0,3,x.boxSize,this.x+x.scrollBtnWidth+(s+1)*x.boxSize-3,this.y,3,x.boxSize)}t.translate(this.x+2*x.scrollBtnWidth+x.boxSize*this.boxes.length,this.y),t.scale(-1,1),t.drawImage(e.editorUI,85,0,6,32,0,0,6,32),t.setTransform(1,0,0,1,0,0)}}class S{static margin=4;static boxSize=32;static scrollBtnWidth=6;constructor(t,e,s){this.editor=t,this.x=e,this.y=s,this.containerX=820,this.height=216,this.props=[{type:"prop",name:"GRAVE_1",width:32,height:32,imageSpec:{id:"graveyardProps",sx:0,sy:0,sWidth:32,sHeight:32}},{type:"prop",name:"GRAVE_2",width:32,height:32,imageSpec:{id:"graveyardProps",sx:32,sy:0,sWidth:32,sHeight:32}},{type:"prop",name:"GRAVE_3",width:32,height:32,imageSpec:{id:"graveyardProps",sx:64,sy:0,sWidth:32,sHeight:32}},{type:"prop",name:"BUSH_1",width:32,height:32,imageSpec:{id:"graveyardProps",sx:0,sy:32,sWidth:32,sHeight:32}},{type:"prop",name:"BUSH_2",width:32,height:32,imageSpec:{id:"graveyardProps",sx:32,sy:32,sWidth:32,sHeight:32}},{type:"prop",name:"BUSH_3",width:32,height:32,imageSpec:{id:"graveyardProps",sx:64,sy:32,sWidth:32,sHeight:32}},{type:"prop",name:"ROCK_1",width:32,height:32,imageSpec:{id:"graveyardProps",sx:0,sy:64,sWidth:32,sHeight:32}},{type:"prop",name:"ROCK_2",width:32,height:32,imageSpec:{id:"graveyardProps",sx:32,sy:64,sWidth:32,sHeight:32}}],this.containerX,this.boxes=this.props.map(((t,e)=>({x:this.x+10+e*S.boxSize,y:this.y+S.margin,width:S.boxSize-2*S.margin,height:S.boxSize-2*S.margin,entity:t}))),this.width=S.boxSize*this.boxes.length+2*S.scrollBtnWidth}update(t,e){}draw(t,e){t.drawImage(e.editorUI,85,0,S.scrollBtnWidth,32,this.x,this.y,S.scrollBtnWidth,32),t.fillStyle="black",t.fillRect(this.x+S.scrollBtnWidth,this.y,S.boxSize*this.boxes.length,S.boxSize);for(const[s,i]of this.boxes.entries()){const h=s*S.boxSize;t.drawImage(e.editorUI,71,0,3,S.boxSize,this.x+S.scrollBtnWidth+h,this.y,3,S.boxSize);const a=i.entity.imageSpec;t.drawImage(e[a.id],a.sx,a.sy,a.sWidth,a.sHeight,Math.round(i.x),Math.round(i.y),i.width,i.height),t.drawImage(e.editorUI,68,0,3,S.boxSize,this.x+S.scrollBtnWidth+(s+1)*S.boxSize-3,this.y,3,S.boxSize)}t.translate(this.x+2*S.scrollBtnWidth+S.boxSize*this.boxes.length,this.y),t.scale(-1,1),t.drawImage(e.editorUI,85,0,6,32,0,0,6,32),t.setTransform(1,0,0,1,0,0)}}const E={images:[{id:"player",path:"images/julhilde.png"},{id:"tile",path:"images/tile.png"},{id:"levelBG",path:"images/background.gif"},{id:"editorUI",path:"images/editorUI.png"},{id:"donutSheet",path:"images/donut.png"},{id:"expressoGangsterSheet",path:"images/expressoGangster.png"},{id:"printerSheet",path:"images/printer.png"},{id:"graveyardProps",path:"images/graveyardObjects.png"},{id:"bullets",path:"images/playerBullet-10x10.png"}],sounds:[{id:"playerShooting1",path:"sounds/player-shoot-1-WG.mp3"},{id:"playerShooting2",path:"sounds/player-shoot-2-WG.mp3"}],levels:[{id:"graveyard",path:"levels/graveyard.json"}]};class T{static dt=0;static updateStep=1/60;static last=window.performance&&window.performance.now?window.performance.now():(new Date).getTime();constructor(t,s){const i=document.getElementById("gameCanvas");this.ctx=i.getContext("2d"),this.audioCtx=s,this.assets=t,this.input=new e(i),this.editor=new u(t.levels.graveyard),this.editor.onToggle((t=>this.currentLevel.reset(t))),this.input.onRelease(e.EDIT,(t=>this.editor.toggle())),this.player=new a({x:100,y:this.ctx.canvas.height-a.avatarHeight}),this.currentLevel=new n(t.levels.graveyard,this.assets.images.levelBG.width,this.ctx.canvas.height,this.player)}start(){window.requestAnimationFrame(this.getAnimationFrameCallback())}update(t){this.editor.enabled?this.editor.update(t,this.input):(this.currentLevel.update(t,this.input),this.player.update(t,this.input,this.currentLevel,this))}draw(){this.ctx.fillStyle=this.editor.enabled?"green":"gray",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.editor.enabled?this.editor.draw(this.ctx,this.assets.images):(this.currentLevel.draw(this.ctx,this.assets.images),this.player.draw(this.ctx,this.assets.images,this.currentLevel.offset))}getAnimationFrameCallback(){const t=this;return function(e){for(T.dt+=Math.min(1,(e-T.last)/1e3);T.dt>T.updateStep;)T.dt-=T.updateStep,t.update(T.updateStep);t.draw(),T.last=e,window.requestAnimationFrame(t.getAnimationFrameCallback())}}}window.onload=function(){const t=new AudioContext;(function(t){return Promise.all([Promise.all(E.images.map((t=>async function(t){const e=new Image;return e.src=t.path,await e.decode(),[t.id,e]}(t)))),Promise.all(E.sounds.map((e=>async function(t,e){const s=await fetch(t.path),i=await s.arrayBuffer(),h=await e.decodeAudioData(i);return[t.id,h]}(e,t)))),Promise.all(E.levels.map((t=>async function(t){const e=await fetch(t.path),s=await e.json();return[t.id,s]}(t))))])})(t).then((([e,s,i])=>{new T({images:Object.fromEntries(e),sounds:Object.fromEntries(s),levels:Object.fromEntries(i)},t).start()}))}})();